<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Ocorrência de Equipamento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configuração do tema escuro
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-primary': '#0F172A', 
                        'dark-secondary': '#1E293B',
                        'tech-color': '#5C6BC0', /* Deep Indigo/Blue para tecnologia */
                        'accent': '#10B981', 
                        'alert-danger': '#DC2626', 
                        'text-light': '#F8FAFC', 
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
         .form-input {
            @apply w-full p-3 bg-white border border-gray-700 rounded-lg text-black focus:ring-tech-color focus:border-tech-color;
        }
        .scrollable-list {
            max-height: 350px;
            overflow-y: auto;
        }
    </style>
    <script>
        // =======================================================
        // MOCK DE DADOS (USADO ATÉ QUE A ROTA GET SEJA IMPLEMENTADA)
        // =======================================================
        const inventoryInUseMOCK = [
            { id: 1, prof_id: 1, prof_name: 'Prof. Ana Mendes', sala_name: 'Sala 6A', linked_student: 'Aluno A (RA 123)', fk_aluno_id: 101, fk_professor_responsavel_id: 1 },
            { id: 4, prof_id: 1, prof_name: 'Prof. Ana Mendes', sala_name: 'Sala 6A', linked_student: null, fk_aluno_id: null, fk_professor_responsavel_id: 1 }, 
            { id: 7, prof_id: 2, prof_name: 'Prof. Bruno Souza', sala_name: 'Sala 7B', linked_student: 'Aluno D', fk_aluno_id: 102, fk_professor_responsavel_id: 2 },
        ];

        let professorsData = [];
        let filteredInventory = [];
        let selectedEquipment = null;


        document.addEventListener('DOMContentLoaded', () => {
            loadProfessorList();
            
            document.getElementById('filter-professor').addEventListener('change', filterInventory);
            document.getElementById('filter-aluno-sim').addEventListener('change', filterInventory);
            document.getElementById('filter-aluno-nao').addEventListener('change', filterInventory);
        });

        // Função auxiliar para carregamento de dados
        async function fetchData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Falha ao buscar dados no servidor.');
                return await response.json();
            } catch (error) {
                console.error("Erro na API:", error);
                return [];
            }
        }

        // 1. Carrega a lista de Professores (Real API Call)
        async function loadProfessorList() {
            const selectProf = document.getElementById('filter-professor');
            selectProf.innerHTML = `<option value="">Carregando...</option>`;
            
            professorsData = await fetchData('/api/funcionarios');

            selectProf.innerHTML = `<option value="">Selecione o Professor *</option>`;
            professorsData.forEach(p => {
                selectProf.innerHTML += `<option value="${p.id}">${p.nome}</option>`;
            });
        }
        
        // 2. Lógica principal de filtragem e exibição das listas (USANDO MOCK TEMPORARIAMENTE)
        window.filterInventory = function() {
            const profId = document.getElementById('filter-professor').value;
            const alunoSim = document.getElementById('filter-aluno-sim').checked;
            const alunoNao = document.getElementById('filter-aluno-nao').checked;
            const listContainer = document.getElementById('inventory-list-container');
            const listBody = document.getElementById('inventory-list-body');
            
            listBody.innerHTML = '';
            listContainer.classList.add('hidden');
            
            if (!profId) return;

            // MOCK: Filtra pelo professor responsável
            filteredInventory = inventoryInUseMOCK.filter(i => String(i.prof_id) === profId);

            if (alunoSim) {
                // SIM: Equipamentos vinculados a ALUNOS
                const linkedItems = filteredInventory.filter(i => i.linked_student !== null);
                linkedItems.forEach(item => {
                    const row = createRow(item, true); // true = with student
                    listBody.appendChild(row);
                });
                document.getElementById('list-title').textContent = 'Equipamentos Atribuídos a Alunos';

            } else if (alunoNao) {
                // NÃO: Equipamentos NÃO vinculados a ALUNOS (responsabilidade geral)
                const unlinkedItems = filteredInventory.filter(i => i.linked_student === null);
                unlinkedItems.forEach(item => {
                    const row = createRow(item, false); // false = unlinked
                    listBody.appendChild(row);
                });
                document.getElementById('list-title').textContent = 'Equipamentos Sob Responsabilidade Geral';
            }

            if (listBody.children.length > 0) {
                 listContainer.classList.remove('hidden');
            } else if (profId) {
                listContainer.classList.remove('hidden');
                listBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-400">Nenhum equipamento encontrado com base no filtro.</td></tr>';
            }
        }
        
        // Função para criar a linha da tabela de seleção
        function createRow(item, withStudent) {
            const tr = document.createElement('tr');
            tr.className = 'border-b border-gray-700 hover:bg-dark-secondary/50 cursor-pointer';
            tr.onclick = () => openIncidentModal(item, withStudent);
            
            const cell1 = document.createElement('td');
            cell1.className = 'p-3 text-sm font-bold text-tech-color';
            // Mock Display
            cell1.textContent = `Eq. ${item.id} (Colm. ${item.id <= 40 ? 1 : 2})`;
            
            const cell2 = document.createElement('td');
            cell2.className = 'p-3 text-sm text-text-light';
            cell2.textContent = withStudent ? item.linked_student : item.sala_name;

            const cell3 = document.createElement('td');
            cell3.className = 'p-3 text-center';
            cell3.innerHTML = `<span class="text-xs text-alert-danger">Registrar Ocorrência &rarr;</span>`;

            tr.appendChild(cell1);
            tr.appendChild(cell2);
            tr.appendChild(cell3);
            return tr;
        }

        // 3. Lógica para abrir o Modal de Ocorrência
        window.openIncidentModal = function(item, withStudent) {
            selectedEquipment = item;
            const modal = document.getElementById('incident-modal');
            
            // Preenchimento de campos Read-Only
            document.getElementById('modal-equipamento').value = `Eq. ${item.id} (Colm. ${item.id <= 40 ? 1 : 2})`;
            document.getElementById('modal-data').value = new Date().toISOString().split('T')[0];
            document.getElementById('modal-hora').value = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
            document.getElementById('modal-prof').value = item.prof_name;
            
            // Lógica Condicional (Aluno/Sala)
            const alunoContainer = document.getElementById('modal-aluno-container');
            const salaContainer = document.getElementById('modal-sala-container');
            
            if (withStudent) {
                document.getElementById('modal-aluno-nome').value = item.linked_student;
                document.getElementById('modal-sala-nome').value = item.sala_name;
                alunoContainer.classList.remove('hidden');
                salaContainer.classList.remove('hidden');
                document.getElementById('modal-subtitle').textContent = 'Relato de Ocorrência Atribuída a Aluno';
            } else {
                alunoContainer.classList.add('hidden');
                // Mantém a sala visível para informar onde o dano ocorreu
                document.getElementById('modal-sala-nome').value = item.sala_name;
                salaContainer.classList.remove('hidden');
                document.getElementById('modal-subtitle').textContent = 'Relato de Ocorrência em Equipamento Não Atribuído';
            }
            
            // Reseta campos editáveis
            document.getElementById('modal-descricao').value = '';
            document.getElementById('modal-acao').value = '';

            modal.classList.remove('hidden');
        }

        // 4. Lógica para Salvar a Ocorrência (REAL API CALL)
        window.saveIncident = async function(event) {
            event.preventDefault();
            
            const profId = document.getElementById('filter-professor').value;
            
            const incidentData = {
                fk_equipamento_id: selectedEquipment.id, 
                fk_professor_id: profId, // ID do professor selecionado no filtro
                fk_aluno_id: selectedEquipment.fk_aluno_id, // Pode ser null
                data_ocorrencia: document.getElementById('modal-data').value,
                hora_ocorrencia: document.getElementById('modal-hora').value,
                descricao: document.getElementById('modal-descricao').value,
                acao: document.getElementById('modal-acao').value,
            };

            try {
                // Rota POST /api/registrar_ocorrencia_equipamento (No seu app.py)
                const response = await fetch('/api/registrar_ocorrencia_equipamento', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(incidentData),
                });

                const result = await response.json();
                
                if (!response.ok) {
                     alert(`ERRO ao registrar: ${result.error || 'Erro desconhecido'}`);
                     return;
                }
                
                alert(result.message);
                
                document.getElementById('incident-modal').classList.add('hidden');
                filterInventory(); 
                
            } catch (error) {
                console.error("Erro ao salvar a ocorrência:", error);
                alert(`ERRO: Não foi possível salvar o registro de ocorrência. Falha de conexão.`);
            }
        }

    </script>
</head>
<body class="bg-dark-primary font-sans text-text-light min-h-screen">
    
    <div id="app-container" class="flex flex-col items-center justify-start p-4 md:p-8 min-h-screen">

        <header class="w-full max-w-7xl text-center mb-8 mt-4">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-alert-danger leading-tight tracking-wider">
                REGISTRO DE OCORRÊNCIA DE EQUIPAMENTOS
            </h1>
            <h2 class="text-xl sm:text-2xl text-text-light mt-2 font-light tracking-wider border-b border-gray-700 pb-2 inline-block">
                Notificação de Dano, Perda ou Mau Uso
            </h2>
            <div class="mt-4">
                 <button type="button" onclick="window.location.href='/gestao_tecnologia'"
                        class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out flex items-center justify-center space-x-2 mx-auto w-full max-w-xs">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z"></path></svg>
                    <span>VOLTAR AO MENU TECNOLOGIA</span>
                </button>
            </div>
        </header>

        <main class="w-full max-w-5xl flex-grow">
            
            <div class="bg-dark-secondary p-8 rounded-xl shadow-2xl space-y-6">
                <h3 class="text-2xl font-bold border-b border-gray-600 pb-3 text-tech-color">1. IDENTIFICAR RESPONSÁVEL E CONTEXTO</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label for="filter-professor" class="block text-sm font-medium text-gray-300 mb-1">Professor Responsável *:</label>
                        <select id="filter-professor" class="form-input" required></select>
                    </div>

                    <div class="md:col-span-2 flex items-center space-x-6 pt-5">
                        <label class="block text-sm font-medium text-gray-300">O equipamento estava com alunos?</label>
                         <div class="flex items-center space-x-4">
                             <label class="inline-flex items-center">
                                <input type="radio" name="aluno-contexto" id="filter-aluno-sim" value="sim" class="form-radio h-5 w-5 text-accent">
                                <span class="ml-2 text-text-light">SIM (Atribuído)</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="aluno-contexto" id="filter-aluno-nao" value="nao" class="form-radio h-5 w-5 text-alert-danger">
                                <span class="ml-2 text-text-light">NÃO (Geral)</span>
                            </label>
                         </div>
                    </div>
                </div>

                <div id="inventory-list-container" class="mt-8 pt-4 border-t border-gray-700 hidden">
                    <h4 id="list-title" class="text-xl font-bold mb-3 text-gray-400">Equipamentos Encontrados</h4>
                     <div class="overflow-y-auto border border-gray-700 rounded-lg scrollable-list">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-dark-primary">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-400 uppercase">EQUIPAMENTO</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-400 uppercase">RESPONSÁVEL/SALA</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-400 uppercase">AÇÃO</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-list-body" class="bg-dark-secondary divide-y divide-gray-700">
                                <tr><td colspan="3" class="p-4 text-center text-gray-400">Selecione o Professor e o Contexto acima.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
        
        <div id="incident-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-dark-secondary rounded-xl shadow-2xl w-full max-w-lg p-6 border-t-4 border-alert-danger">
                
                <h3 class="text-2xl font-extrabold mb-4 text-alert-danger border-b border-gray-700 pb-2">REGISTRO DE OCORRÊNCIA</h3>
                <p id="modal-subtitle" class="text-gray-400 mb-4"></p>

                <form onsubmit="saveIncident(event)">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Equipamento (ID):</label>
                            <input type="text" id="modal-equipamento" class="form-input bg-gray-700 cursor-not-allowed" readonly>
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Professor Responsável:</label>
                            <input type="text" id="modal-prof" class="form-input bg-gray-700 cursor-not-allowed" readonly>
                        </div>
                    </div>

                    <div id="modal-aluno-container" class="hidden">
                        <label class="block text-sm font-medium text-gray-300 mb-1">Aluno Vinculado:</label>
                        <input type="text" id="modal-aluno-nome" class="form-input mb-2 bg-gray-700 cursor-not-allowed" readonly>
                    </div>
                    <div id="modal-sala-container" class="hidden">
                        <label class="block text-sm font-medium text-gray-300 mb-1">Sala de Uso:</label>
                        <input type="text" id="modal-sala-nome" class="form-input mb-4 bg-gray-700 cursor-not-allowed" readonly>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Data da Ocorrência:</label>
                            <input type="date" id="modal-data" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Hora da Ocorrência:</label>
                            <input type="time" id="modal-hora" class="form-input" required>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="modal-descricao" class="block text-sm font-medium text-gray-300 mb-1">Descrição do Incidente *:</label>
                        <textarea id="modal-descricao" rows="3" class="form-input resize-none" required placeholder="Ex: Tela rachada, cabo danificado, equipamento ausente."></textarea>
                    </div>
                    <div class="mb-6">
                        <label for="modal-acao" class="block text-sm font-medium text-gray-300 mb-1">Ação Tomada/Encaminhamento *:</label>
                        <textarea id="modal-acao" rows="2" class="form-input resize-none" required placeholder="Ex: Coordenador notificado, aluno advertido, item recolhido para reparo."></textarea>
                    </div>


                    <div class="pt-4 text-right">
                        <button type="button" onclick="document.getElementById('incident-modal').classList.add('hidden')" 
                                class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 mr-2">
                            CANCELAR
                        </button>
                        <button type="submit" class="bg-alert-danger hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                            REGISTRAR OCORRÊNCIA
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <footer class="w-full text-center mt-10 p-4 text-gray-400 text-sm border-t border-gray-800">
            <p class="mb-1 text-base font-medium">
                DESENVOLVEDOR: MARCELO CARDES E LUIS FELIPE CARDES
            </p>
            <p class="text-xs font-light tracking-wide">
                LICENCIADO COMO TESTE PARA E.E. PEI PROFESSORA IRENE DIAS
            </p>
        </footer>

    </div>

</body>
</html>