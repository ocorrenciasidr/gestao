<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recebimento e Vinculação de Equipamentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configuração do tema escuro
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-primary': '#0F172A', 
                        'dark-secondary': '#1E293B',
                        'tech-color': '#5C6BC0', 
                        'accent': '#10B981', 
                        'alert-danger': '#DC2626',
                        'alert-warning': '#F59E0B',
                        'text-light': '#F8FAFC', 
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
         .form-input {
            @apply w-full p-3 bg-white border border-gray-700 rounded-lg text-black focus:ring-tech-color focus:border-tech-color;
        }
        .scrollable-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .read-only {
            @apply bg-gray-700 text-gray-300 cursor-not-allowed;
        }
    </style>
    <script>
        // =======================================================
        // VARIÁVEIS GLOBAIS E MOCK
        // =======================================================
        let professorsData = [];
        let agendamentosData = [];
        let alunosData = []; // Alunos da sala do agendamento
        let equipamentosDisponiveis = []; // Equipamentos reservados para a aula (MOCK)
        let equipamentosSelecionados = new Set(); // IDs dos equipamentos já vinculados

        let currentAgendamento = null; 
        
        // MOCK: Simulação de dados (REMOVA AO CONECTAR AS ROTAS REAIS)
        const mockEquipamentos = [
             { id: 'E01', nome: 'Colmeia 1 - Eq. 1' }, 
             { id: 'E02', nome: 'Colmeia 1 - Eq. 2' }, 
             { id: 'E03', nome: 'Colmeia 1 - Eq. 3' }, 
             { id: 'E04', nome: 'Colmeia 1 - Eq. 4' },
             { id: 'E05', nome: 'Colmeia 1 - Eq. 5' },
        ];


        document.addEventListener('DOMContentLoaded', () => {
            loadProfessorList();
            document.getElementById('filter-professor').addEventListener('change', loadAgendamentos);
            document.getElementById('select-agendamento').addEventListener('change', showButtons);
        });

        // Helper para carregamento de dados
        async function fetchData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                     const errorData = await response.json();
                     throw new Error(errorData.error || 'Falha ao buscar dados no servidor.');
                }
                return await response.json();
            } catch (error) {
                console.error("Erro na API:", error);
                // Retorna um array vazio em caso de erro, para evitar quebrar o app
                return []; 
            }
        }

        // 1. Carrega a lista de Professores (do Flask /api/funcionarios)
        async function loadProfessorList() {
            const selectProf = document.getElementById('filter-professor');
            selectProf.innerHTML = `<option value="">Carregando...</option>`;
            
            professorsData = await fetchData('/api/funcionarios');

            selectProf.innerHTML = `<option value="">SELECIONE O PROFESSOR</option>`;
            professorsData.forEach(p => {
                selectProf.innerHTML += `<option value="${p.id}">${p.nome}</option>`;
            });
        }
        
        // 2. Carrega agendamentos pendentes do Professor (Rota /api/agendamentos_pendentes/<professor_id>)
        window.loadAgendamentos = async function() {
            const profId = document.getElementById('filter-professor').value;
            const selectAgendamento = document.getElementById('select-agendamento');
            const agendamentoContainer = document.getElementById('agendamento-container');
            
            selectAgendamento.innerHTML = `<option value="">Carregando Agendamentos...</option>`;
            selectAgendamento.disabled = true;
            agendamentoContainer.classList.add('hidden');
            document.getElementById('retirada-devolucao-buttons').classList.add('hidden');
            document.getElementById('vinculacao-container').classList.add('hidden'); 
            
            if (!profId) return;

            try {
                // Rotas reais devem ser usadas aqui
                agendamentosData = await fetchData(`/api/agendamentos_pendentes/${profId}`);
            } catch(e) {
                 selectAgendamento.innerHTML = `<option value="">ERRO AO CARREGAR</option>`;
                 return;
            }
            
            if (agendamentosData.length === 0) {
                 selectAgendamento.innerHTML = `<option value="">NENHUM AGENDAMENTO PENDENTE</option>`;
                 agendamentoContainer.classList.remove('hidden');
                 return;
            }

            selectAgendamento.innerHTML = `<option value="">SELECIONE O AGENDAMENTO</option>`;
            agendamentosData.forEach(ag => {
                // Assumindo que o agendamento no Supabase tem (id, fk_sala_id, data_uso, quantidade, status)
                const nomeSala = ag.sala_nome || `Sala ID: ${ag.fk_sala_id}`;
                const dataUso = ag.data_uso || ag.data;
                const status = ag.status || 'AGENDADO';
                
                selectAgendamento.innerHTML += `<option value="${ag.id}">[${dataUso}] ${nomeSala} (${ag.quantidade} Eq.) - STATUS: ${status}</option>`;
            });
            selectAgendamento.disabled = false;
            agendamentoContainer.classList.remove('hidden');
        }

        // 3. Exibe botões de Ação ao selecionar um agendamento
        window.showButtons = function() {
            const agendamentoId = document.getElementById('select-agendamento').value;
            const buttonContainer = document.getElementById('retirada-devolucao-buttons');
            
            buttonContainer.classList.add('hidden');
            document.getElementById('vinculacao-container').classList.add('hidden');
            
            if (!agendamentoId) return;

            currentAgendamento = agendamentosData.find(ag => ag.id === agendamentoId);
            
            // Lógica de exibição dos botões
            const status = currentAgendamento.status;
            const btnReceber = document.getElementById('btn-receber');
            const btnDevolver = document.getElementById('btn-devolver');

            if (status === 'AGENDADO') {
                btnReceber.classList.remove('hidden');
                btnDevolver.classList.add('hidden');
            } else if (status === 'EM USO (RETIRADO)') {
                 btnReceber.classList.add('hidden');
                 btnDevolver.classList.remove('hidden');
            } else {
                 btnReceber.classList.add('hidden');
                 btnDevolver.classList.add('hidden');
                 alert(`Agendamento ${status}. Não há ação pendente.`);
                 return;
            }
            
            // Prepara a lista de equipamentos para a vinculação (MOCK)
            // Em um cenário real, você faria um FETCH para obter a lista exata de IDs reservados ou retirados.
            equipamentosDisponiveis = mockEquipamentos; // Usa mock para o teste de interface.
            equipamentosSelecionados.clear();
            
            buttonContainer.classList.remove('hidden');
        }

        // 4. Fluxo de "Recebimento" (Abre a área de Vinculação)
        window.retirarEquipamentos = async function() {
            if (!currentAgendamento) return;

            // Carrega Alunos da Sala do Agendamento (Rota /api/alunos_por_sala/ - Rota 3)
            const salaId = currentAgendamento.fk_sala_id; 
            
            try {
                 alunosData = await fetchData(`/api/alunos_por_sala/${salaId}`);
            } catch (e) {
                 alert('Erro ao carregar lista de alunos. Verifique a Rota /api/alunos_por_sala no Flask.');
                 return;
            }
            
            document.getElementById('retirada-devolucao-buttons').classList.add('hidden');
            document.getElementById('vinculacao-container').classList.remove('hidden');
            document.getElementById('termo-final-container').classList.remove('hidden');

            renderAlunosEquipamentos();
        }
        
        // 5. Renderiza a tabela Aluno x Equipamento
        function renderAlunosEquipamentos() {
            const tbody = document.getElementById('vinculacao-table-body');
            tbody.innerHTML = '';
            
            alunosData.forEach(aluno => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-700 hover:bg-dark-primary/50';
                
                tr.innerHTML = `
                    <td class="p-3 font-semibold text-text-light">${aluno.nome}</td>
                    <td class="p-3">
                         <select id="select-eq-${aluno.id}" data-aluno-id="${aluno.id}" class="form-input w-full p-2" onchange="handleEquipamentoChange(this)">
                             ${getEquipamentoOptions()}
                         </select>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // 6. Gera as opções do dropdown (excluindo os já selecionados)
        function getEquipamentoOptions() {
            let options = '<option value="">Sem Equipamento</option>';
            
            equipamentosDisponiveis.forEach(eq => {
                const isSelected = equipamentosSelecionados.has(eq.id);
                if (!isSelected) {
                    options += `<option value="${eq.id}">${eq.nome}</option>`;
                }
            });
            
            return options;
        }

        // 7. Lógica ao mudar o dropdown (Garante que cada equipamento é único)
        window.handleEquipamentoChange = function(selectElement) {
            
            // Recalcula todos os itens selecionados
            equipamentosSelecionados.clear();
            document.querySelectorAll('#vinculacao-table-body select').forEach(s => {
                if (s.value) {
                    equipamentosSelecionados.add(s.value);
                }
            });
            
            // Atualiza os dropdowns para refletir a nova disponibilidade
            document.querySelectorAll('#vinculacao-table-body select').forEach(s => {
                const oldValue = s.value; // Mantém o valor que o usuário escolheu
                
                let newOptions = '<option value="">Sem Equipamento</option>';
                equipamentosDisponiveis.forEach(eq => {
                    // Equipamento está disponível se:
                    // 1. Não estiver em 'equipamentosSelecionados' OU
                    // 2. Se for o valor que ele JÁ havia selecionado (oldValue)
                    const isReserved = equipamentosSelecionados.has(eq.id) && String(eq.id) !== String(oldValue);
                    if (!isReserved) {
                        newOptions += `<option value="${eq.id}">${eq.nome}</option>`;
                    }
                });
                s.innerHTML = newOptions;
                s.value = oldValue; // Restaura o valor
            });
        }
        
        // 8. Finaliza a Retirada com a Vinculação (Rota 20: /api/finalizar_retirada_equipamento)
        window.finalizarRetirada = async function() {
            if (!currentAgendamento) return;
            
            const termoAceite = document.getElementById('termo-aceite').checked;
            if (!termoAceite) {
                alert('Você deve aceitar o Termo de Responsabilidade para continuar.');
                return;
            }
            
            const vinculacoes = [];
            document.querySelectorAll('#vinculacao-table-body select').forEach(s => {
                if (s.value) {
                    vinculacoes.push({
                        aluno_id: s.dataset.alunoId,
                        equipamento_id: s.value,
                        data_retirada: new Date().toISOString() 
                    });
                }
            });
            
            const dadosFinalizacao = {
                agendamento_id: currentAgendamento.id,
                vinculacoes: vinculacoes,
                status_agendamento: 'EM USO (RETIRADO)',
                data_retirada_geral: new Date().toISOString(),
                termo_aceite_registro: document.getElementById('termo-texto').textContent
            };
            
            // CHAMADA REAL À API DO FLASK (Rota 20)
            try {
                const response = await fetch('/api/finalizar_retirada_equipamento', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dadosFinalizacao)
                });
                
                const result = await response.json();

                if (response.ok) {
                    alert(`Recebimento concluído. ${result.message}`);
                    window.location.reload(); 
                } else {
                    alert(`Erro ao finalizar recebimento: ${result.error}`);
                }
            } catch (e) {
                 alert(`Erro de comunicação com o servidor.`);
            }
        }
        
        // 9. Finaliza a Devolução (Rota 21: /api/finalizar_devolucao_equipamento)
        window.devolverEquipamentos = async function() {
            if (!currentAgendamento) return;
            
            if (!confirm(`Confirma a devolução de todos os equipamentos do agendamento [${currentAgendamento.data_uso || currentAgendamento.data}] de ${currentAgendamento.prof_nome}? Isso encerrará o uso.`)) {
                return;
            }
            
            const dadosDevolucao = {
                agendamento_id: currentAgendamento.id,
                status_agendamento: 'FINALIZADO',
                data_devolucao: new Date().toISOString(),
            };
            
            // CHAMADA REAL À API DO FLASK (Rota 21)
            try {
                const response = await fetch('/api/finalizar_devolucao_equipamento', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dadosDevolucao)
                });
                
                const result = await response.json();

                if (response.ok) {
                    alert(`Devolução concluída. ${result.message}`);
                    window.location.reload(); 
                } else {
                    alert(`Erro ao finalizar devolução: ${result.error}`);
                }
            } catch (e) {
                 alert(`Erro de comunicação com o servidor.`);
            }
        }
    </script>
</head>
<body class="bg-dark-primary font-sans text-text-light min-h-screen">
    
    <div id="app-container" class="flex flex-col items-center justify-start p-4 md:p-8 min-h-screen">

        <header class="w-full text-center mb-8 mt-4">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-tech-color leading-tight tracking-wider">
                MÓDULO DE TECNOLOGIA
            </h1>
            <h2 class="text-xl sm:text-2xl text-text-light mt-2 font-light tracking-wider border-b border-gray-700 pb-2 inline-block">
                RECEBIMENTO E DEVOLUÇÃO DE EQUIPAMENTOS
            </h2>
            <div class="mt-4">
                 <button type="button" onclick="window.location.href='/gestao_tecnologia'"
                        class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out flex items-center justify-center space-x-2 mx-auto w-full max-w-xs">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z"></path></svg>
                    <span>VOLTAR AO MENU TECNOLOGIA</span>
                </button>
            </div>
        </header>

        <main class="w-full max-w-5xl flex-grow">
            
            <div class="bg-dark-secondary p-8 rounded-xl shadow-2xl space-y-6">
                
                <h3 class="text-2xl font-bold border-b border-gray-600 pb-3 text-tech-color">1. FILTRO: Agendamentos Pendentes</h3>
                
                <div id="agendamento-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="filter-professor" class="block text-sm font-medium text-gray-300 mb-1">Professor Agendador *:</label>
                        <select id="filter-professor" class="form-input" required></select>
                    </div>
                    <div>
                        <label for="select-agendamento" class="block text-sm font-medium text-gray-300 mb-1">Agendamento Pendente *:</label>
                        <select id="select-agendamento" class="form-input" required disabled></select>
                    </div>
                </div>

                <div id="retirada-devolucao-buttons" class="pt-4 border-t border-gray-700 hidden">
                    <p class="text-sm text-gray-400 mb-3 text-center">Selecione a ação a ser realizada para o agendamento:</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button id="btn-receber" onclick="retirarEquipamentos()"
                                class="bg-accent hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg transition shadow-lg transform hover:scale-[1.01]">
                            <svg class="w-6 h-6 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            CONFIRMAR RECEBIMENTO (Retirada)
                        </button>
                        <button id="btn-devolver" onclick="devolverEquipamentos()"
                                class="bg-alert-danger hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition shadow-lg transform hover:scale-[1.01] hidden">
                            <svg class="w-6 h-6 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            DEVOLVER EQUIPAMENTOS (Finalizar)
                        </button>
                    </div>
                </div>
            </div>

            <div id="vinculacao-container" class="bg-dark-secondary p-8 rounded-xl shadow-2xl space-y-6 mt-6 hidden">
                 <h3 class="text-2xl font-bold border-b border-gray-600 pb-3 text-tech-color">2. VINCULAÇÃO ALUNO X EQUIPAMENTO</h3>
                 
                 <div class="overflow-x-auto border border-gray-700 rounded-lg scrollable-list">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-dark-primary sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">ALUNO NA SALA</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">EQUIPAMENTO ATRIBUÍDO *</th>
                            </tr>
                        </thead>
                        <tbody id="vinculacao-table-body" class="bg-dark-secondary divide-y divide-gray-700">
                             <tr><td colspan="2" class="p-4 text-center text-gray-400">Selecione um agendamento e clique em 'Receber'</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="termo-final-container" class="bg-dark-secondary p-8 rounded-xl shadow-2xl space-y-6 mt-6 hidden">
                 <h3 class="text-2xl font-bold border-b border-gray-600 pb-3 text-alert-warning">3. ACEITE E CONFIRMAÇÃO</h3>

                 <div class="p-4 bg-dark-primary border border-gray-700 rounded-lg">
                    <p id="termo-texto" class="text-sm text-gray-300 italic">
                        Professor, os equipamentos estão sob a sua responsabilidade. Registre corretamente o aluno que está com cada equipamento. Se algum equipamento apresentar problema, registre na tela de **Ocorrência de Tecnologia**. Se o computador estiver com aluno e for caso de depredação, além de registrar a ocorrência em tecnologia, registre a **ocorrência normal de convivência**.
                    </p>
                 </div>

                 <div class="flex items-center space-x-3">
                     <input type="checkbox" id="termo-aceite" class="form-checkbox h-5 w-5 text-accent rounded focus:ring-accent">
                     <label for="termo-aceite" class="text-sm font-medium">Li e aceito o Termo de Responsabilidade e Orientações.</label>
                 </div>
                 
                 <button onclick="finalizarRetirada()" 
                         class="w-full bg-tech-color hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out shadow-lg transform hover:scale-[1.01]">
                     FINALIZAR RECEBIMENTO E ATRIBUIR RESPONSABILIDADE
                 </button>
            </div>

        </main>
        
        <footer class="w-full text-center mt-10 p-4 text-gray-400 text-sm border-t border-gray-800">
            <p class="mb-1 text-base font-medium">
                DESENVOLVEDOR: MARCELO CARDES E LUIS FELIPE CARDES
            </p>
            <p class="text-xs font-light tracking-wide">
                LICENCIADO COMO TESTE PARA E.E. PEI PROFESSORA IRENE DIAS
            </p>
        </footer>

    </div>

</body>
</html>