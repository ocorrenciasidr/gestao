<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestão de Ocorrências Abertas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'dark-primary': '#0F172A',
            'dark-secondary': '#1E293B',
            'accent': '#10B981',
            'text-light': '#F8FAFC',
            'danger': '#DC2626',
            'tutor-color': '#007ACC',
            'coord-color': '#F59E0B',
            'gestao-color': '#EF4444',
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
        },
      },
    };

    document.addEventListener("DOMContentLoaded", carregarOcorrencias);

    function mostrarMensagem(texto, tipo) {
      const msgElement = document.getElementById("mensagem-status");
      msgElement.textContent = texto;
      msgElement.classList.remove(
        "hidden",
        "bg-accent",
        "bg-danger",
        "bg-dark-secondary",
        "text-yellow-400"
      );

      if (tipo === "success") msgElement.classList.add("bg-accent");
      else if (tipo === "danger") msgElement.classList.add("bg-danger");
      else if (tipo === "info")
        msgElement.classList.add("bg-dark-secondary", "text-yellow-400");

      msgElement.classList.remove("hidden");
      setTimeout(() => {
        msgElement.classList.add("hidden");
      }, 4000);
    }

    function renderizarAcoes(ocorrencia) {
      const id = ocorrencia.id;
      let html = `
        <div class="flex items-center space-x-3">
          <a href="/gestao_ocorrencia_editar?id=${id}&modo=visualizar" title="Visualizar Detalhes"
              class="text-gray-400 hover:text-accent transition duration-150">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          </a>`;

      let indicadores = "";
      if (ocorrencia.solicitado_tutor && !ocorrencia.dt_atendimento_tutor) {
        indicadores += `<a href="/gestao_ocorrencia_editar?id=${id}&modo=atendimento&nivel=tutor"
                            class="bg-tutor-color/20 text-tutor-color text-xs font-bold px-2 py-1 rounded-full border border-tutor-color hover:bg-tutor-color hover:text-white transition">T</a>`;
      }
      if (ocorrencia.solicitado_coordenacao && !ocorrencia.dt_atendimento_coordenacao) {
        indicadores += `<a href="/gestao_ocorrencia_editar?id=${id}&modo=atendimento&nivel=coordenacao"
                            class="bg-coord-color/20 text-coord-color text-xs font-bold px-2 py-1 rounded-full border border-coord-color hover:bg-coord-color hover:text-white transition">C</a>`;
      }
      if (ocorrencia.solicitado_gestao && !ocorrencia.dt_atendimento_gestao) {
        indicadores += `<a href="/gestao_ocorrencia_editar?id=${id}&modo=atendimento&nivel=gestao"
                            class="bg-gestao-color/20 text-gestao-color text-xs font-bold px-2 py-1 rounded-full border border-gestao-color hover:bg-gestao-color hover:text-white transition">G</a>`;
      }

      if (indicadores)
        html += `<div class="ml-4 space-x-2">${indicadores}</div>`;
      html += `</div>`;
      return html;
    }

    async function carregarOcorrencias() {
      mostrarMensagem("Carregando ocorrências abertas...", "info");
      const tabelaCorpo = document.getElementById("ocorrencias-corpo");

      try {
        const response = await fetch("/api/ocorrencias_abertas");
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`API falhou com status ${response.status}. ${errorText}`);
        }

        const todasOcorrencias = await response.json();

        const ocorrenciasAbertas = todasOcorrencias.filter((occ) => {
          const tutorPendente = occ.solicitado_tutor && !occ.dt_atendimento_tutor;
          const coordPendente = occ.solicitado_coordenacao && !occ.dt_atendimento_coordenacao;
          const gestaoPendente = occ.solicitado_gestao && !occ.dt_atendimento_gestao;
          return tutorPendente || coordPendente || gestaoPendente;
        });

        tabelaCorpo.innerHTML = "";

        if (ocorrenciasAbertas.length === 0) {
          tabelaCorpo.innerHTML = `<tr><td colspan="7" class="text-center py-6 text-gray-400">Nenhuma ocorrência pendente.</td></tr>`;
          mostrarMensagem("Nenhuma ocorrência pendente.", "info");
          return;
        }

        let rowsHtml = "";
        ocorrenciasAbertas.forEach((ocorrencia) => {
          rowsHtml += `
              <tr class="hover:bg-dark-secondary/50 transition duration-150">
                <td class="p-3 text-sm font-medium text-text-light">${ocorrencia.id}</td>
                <td class="p-3 text-sm text-gray-300">${ocorrencia.data_hora}</td>
                <td class="p-3 text-sm text-gray-300">${ocorrencia.aluno_nome}</td>
                <td class="p-3 text-sm text-gray-300">${ocorrencia.sala_nome}</td>
                <td class="p-3 text-sm text-gray-300">${ocorrencia.professor_nome}</td>
                <td class="p-3 text-sm text-gray-300">${ocorrencia.tutor_nome}</td>
                <td class="p-3 text-sm whitespace-nowrap">${renderizarAcoes(ocorrencia)}</td>
              </tr>`;
        });

        tabelaCorpo.innerHTML = rowsHtml;
        mostrarMensagem("Ocorrências carregadas com sucesso!", "success");
      } catch (error) {
        console.error(error);
        mostrarMensagem("Erro ao carregar lista. Ver console.", "danger");
      }
    }
  </script>
</head>

<body class="bg-dark-primary min-h-screen p-8 text-text-light">
  <div id="mensagem-status"
    class="hidden fixed top-4 right-4 p-4 rounded-lg shadow-xl text-text-light z-50 transition-opacity duration-300"
    role="alert"></div>

  <div class="max-w-7xl mx-auto">
    <header class="text-center mb-8 mt-4">
      <h1 class="text-4xl font-extrabold text-accent tracking-wider">
        SISTEMA DE GESTÃO DE CONVIVÊNCIA ESCOLAR
      </h1>
      <h2 class="text-2xl text-text-light mt-2 font-light border-b border-gray-700 pb-2 inline-block">
        OCORRÊNCIAS ABERTAS
      </h2>
      <div class="mt-4 flex flex-wrap justify-center gap-4">
        <button type="button" onclick="window.location.href='/gestao_ocorrencia'"
          class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center space-x-2 w-full max-w-[150px]">
          <span>Voltar</span>
        </button>
        <button type="button" onclick="window.location.href='/gestao_ocorrencia_nova.html'"
          class="bg-accent hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center space-x-2 w-full max-w-[180px]">
          <span>Nova Ocorrência</span>
        </button>
        <button type="button" onclick="window.location.href='/gestao_ocorrencia_finalizadas.html'"
          class="bg-emerald-700 hover:bg-emerald-800 text-white font-bold py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center space-x-2 w-full max-w-[220px]">
          <span>Finalizadas</span>
        </button>
      </div>
    </header>

    <main class="overflow-x-auto bg-dark-secondary rounded-xl shadow-2xl p-4">
      <table class="min-w-full divide-y divide-gray-700">
        <thead class="bg-dark-primary">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">ID</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Data Reg.</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Aluno</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Sala</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Professor</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Tutor</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Ações</th>
          </tr>
        </thead>
        <tbody id="ocorrencias-corpo" class="divide-y divide-gray-800">
          <tr><td colspan="7" class="text-center py-4 text-gray-400">Carregando dados...</td></tr>
        </tbody>
      </table>
    </main>
  </div>
</body>
</html>
