<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestão de Ocorrências Abertas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'dark-primary': '#0F172A',
            'dark-secondary': '#1E293B',
            'accent': '#10B981',
            'text-light': '#F8FAFC',
            'danger': '#DC2626',
            'tutor-color': '#007ACC',
            'coord-color': '#F59E0B',
            'gestao-color': '#EF4444',
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
        },
      },
    };

    document.addEventListener("DOMContentLoaded", carregarOcorrencias);

    function mostrarMensagem(texto, tipo) {
      const msgElement = document.getElementById("mensagem-status");
      msgElement.textContent = texto;
      msgElement.classList.remove("hidden", "bg-accent", "bg-danger", "bg-dark-secondary", "text-yellow-400");

      if (tipo === "success") msgElement.classList.add("bg-accent");
      else if (tipo === "danger") msgElement.classList.add("bg-danger");
      else if (tipo === "info") msgElement.classList.add("bg-dark-secondary", "text-yellow-400");

      msgElement.classList.remove("hidden");
      setTimeout(() => msgElement.classList.add("hidden"), 4000);
    }

    // === Exibe T/C/G apenas se solicitado = true e atendimento = vazio ===
    function renderizarAcoes(ocorrencia) {
      const numero = ocorrencia.id || ocorrencia.numero;
      let html = `
        <div class="flex items-center space-x-3">
          <a href="/gestao_ocorrencia_editar?id=${numero}&modo=visualizar" title="Visualizar Detalhes"
              class="text-gray-400 hover:text-accent transition duration-150">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
          </a>`;

      let indicadores = "";

      // Conversão segura de valores Supabase
      const solicitadoTutor = ocorrencia.solicitado_tutor === true || ocorrencia.solicitado_tutor === "true" || ocorrencia.solicitado_tutor === 1;
      const solicitadoCoord = ocorrencia.solicitado_coordenacao === true || ocorrencia.solicitado_coordenacao === "true" || ocorrencia.solicitado_coordenacao === 1;
      const solicitadoGestao = ocorrencia.solicitado_gestao === true || ocorrencia.solicitado_gestao === "true" || ocorrencia.solicitado_gestao === 1;

      const atendTutor = (ocorrencia.atendimento_tutor || "").trim();
      const atendCoord = (ocorrencia.atendimento_coordenacao || "").trim();
      const atendGestao = (ocorrencia.atendimento_gestao || "").trim();

      // Tutor
      if (solicitadoTutor && atendTutor === "") {
        indicadores += `<a href="/gestao_ocorrencia_editar?id=${numero}&modo=atendimento&nivel=tutor"
                          class="bg-tutor-color/20 text-tutor-color text-xs font-bold px-2 py-1 rounded-full border border-tutor-color hover:bg-tutor-color hover:text-white transition">T</a>`;
      }

      // Coordenação
      if (solicitadoCoord && atendCoord === "") {
        indicadores += `<a href="/gestao_ocorrencia_editar?id=${numero}&modo=atendimento&nivel=coordenacao"
                          class="bg-coord-color/20 text-coord-color text-xs font-bold px-2 py-1 rounded-full border border-coord-color hover:bg-coord-color hover:text-white transition">C</a>`;
      }

      // Gestão
      if (solicitadoGestao && atendGestao === "") {
        indicadores += `<a href="/gestao_ocorrencia_editar?id=${numero}&modo=atendimento&nivel=gestao"
                          class="bg-gestao-color/20 text-gestao-color text-xs font-bold px-2 py-1 rounded-full border border-gestao-color hover:bg-gestao-color hover:text-white transition">G</a>`;
      }

      if (indicadores)
        html += `<div class="ml-4 space-x-2">${indicadores}</div>`;

      html += `</div>`;
      return html;
    }

    async function carregarOcorrencias() {
      mostrarMensagem("Carregando ocorrências...", "info");
      const tabelaCorpo = document.getElementById("ocorrencias-corpo");
      // Mensagem clara de que está buscando dados no servidor
      tabelaCorpo.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-yellow-400">Buscando dados no servidor...</td></tr>`;

      try {
        // ATENÇÃO: A URL de API deve ser para o endpoint que retorna todas as ocorrências
        const response = await fetch("/api/ocorrencias_abertas");
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`API falhou com status ${response.status}. Detalhes: ${errorText.substring(0, 100)}`);
        }

        const todasOcorrencias = await response.json();
        
        // -----------------------------------------------------------
        // INÍCIO: ALTERAÇÃO PARA DEBUG DE CARREGAMENTO (MOSTRAR TUDO)
        // O código agora mostrará TODAS as ocorrências do banco de dados,
        // mesmo as 'Finalizadas', para confirmar que a tabela carrega.
        // -----------------------------------------------------------
        const ocorrenciasAbertas = todasOcorrencias;
        
        /* CÓDIGO DE FILTRO ORIGINAL (COMENTADO PARA DEBUG)
        const ocorrenciasAbertas = todasOcorrencias.filter((occ) => {
          const solicitadoTutor = occ.solicitado_tutor === true || occ.solicitado_tutor === "true" || occ.solicitado_tutor === 1;
          const solicitadoCoord = occ.solicitado_coordenacao === true || occ.solicitado_coordenacao === "true" || occ.solicitado_coordenacao === 1;
          const solicitadoGestao = occ.solicitado_gestao === true || occ.solicitado_gestao === "true" || occ.solicitado_gestao === 1;

          const pendenteTutor = solicitadoTutor && (!occ.atendimento_tutor || occ.atendimento_tutor.trim() === "");
          const pendenteCoord = solicitadoCoord && (!occ.atendimento_coordenacao || occ.atendimento_coordenacao.trim() === "");
          const pendenteGestao = solicitadoGestao && (!occ.atendimento_gestao || occ.atendimento_gestao.trim() === "");

          return pendenteTutor || pendenteCoord || pendenteGestao;
        });
        */
        // -----------------------------------------------------------
        // FIM: ALTERAÇÃO PARA DEBUG DE CARREGAMENTO
        // -----------------------------------------------------------


        tabelaCorpo.innerHTML = "";

        if (ocorrenciasAbertas.length === 0) {
          tabelaCorpo.innerHTML = `<tr><td colspan="7" class="text-center py-6 text-gray-400">Nenhuma ocorrência encontrada.</td></tr>`;
          mostrarMensagem("Nenhuma ocorrência encontrada.", "info");
          return;
        }

        let rowsHtml = "";
        ocorrenciasAbertas.forEach((ocorrencia) => {
          rowsHtml += `
            <tr class="hover:bg-dark-secondary/50 transition duration-150">
              <td class="p-3 text-sm font-medium text-text-light">${ocorrencia.numero}</td>
              <td class="p-3 text-sm text-gray-300">${ocorrencia.data_hora || ""}</td>
              <td class="p-3 text-sm text-gray-300">${ocorrencia.aluno_nome || ""}</td>
              <td class="p-3 text-sm text-gray-300">${ocorrencia.sala_nome || ""}</td>
              <td class="p-3 text-sm text-gray-300">${ocorrencia.professor_nome || ""}</td>
              <td class="p-3 text-sm text-gray-300">${ocorrencia.tutor_nome || ""}</td>
              <td class="p-3 text-sm whitespace-nowrap">${renderizarAcoes(ocorrencia)}</td>
            </tr>`;
        });

        tabelaCorpo.innerHTML = rowsHtml;
        mostrarMensagem(`Total de ${ocorrenciasAbertas.length} registros carregados.`, "success");
      } catch (error) {
        console.error("Erro no carregamento de ocorrências:", error);
        tabelaCorpo.innerHTML = `<tr><td colspan="7" class="text-center py-6 text-red-400">ERRO: ${error.message}</td></tr>`;
        mostrarMensagem("Erro ao carregar lista. Verifique console e Backend.", "danger");
      }
    }
  </script>
</head>

<body class="bg-dark-primary min-h-screen p-8 text-text-light">
  <div id="mensagem-status"
    class="hidden fixed top-4 right-4 p-4 rounded-lg shadow-xl text-text-light z-50 transition-opacity duration-300"
    role="alert"></div>

  <div class="max-w-7xl mx-auto">
    <header class="text-center mb-8 mt-4">
      <h1 class="text-2xl text-text-light mt-2 font-light border-b border-gray-700 pb-2 inline-block">
        SISTEMA DE GESTÃO DE CONVIVÊNCIA ESCOLAR
      </h1><br>
      <h2 class="text-lg text-text-light mt-2 font-light border-b border-gray-700 pb-2 inline-block">
        GESTÃO DE OCORRÊNCIAS - OCORRÊNCIAS ABERTAS
      </h2>
        <button onclick="window.location.href='/gestao_ocorrencia'"
                        class="mt-4 px-4 py-2 text-sm font-medium rounded-lg text-gray-300 border border-gray-600 hover:bg-gray-700 transition duration-150 flex items-center mx-auto">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                Voltar ao Menu de Ocorrências
            </button>
      <div class="mt-4 flex flex-wrap justify-center gap-4">
        </div>
    </header>

    <main class="overflow-x-auto bg-dark-secondary rounded-xl shadow-2xl p-4">
      <table class="min-w-full divide-y divide-gray-700">
        <thead class="bg-dark-primary">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Número</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Data Reg.</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Aluno</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Sala</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Professor</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Tutor</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Ações</th>
          </tr>
        </thead>
        <tbody id="ocorrencias-corpo" class="divide-y divide-gray-800">
          <tr><td colspan="7" class="text-center py-4 text-gray-400">Carregando dados...</td></tr>
        </tbody>
      </table>
    </main>
    <footer class="w-full text-center mt-10 p-4 text-gray-400 text-sm border-t border-gray-800">
          <p class="mb-1 text-base font-medium">
              DESENVOLVEDOR: MARCELO ANDRÉ NOGUEIRA CARDES
          </p>
          <p class="text-xs font-light tracking-wide">
              LICENCIADO COMO TESTE PARA E.E. PEI PROFESSORA IRENE DIAS RIBEIRO
          </p>
        </footer>

  </div>
</body>
</html>
