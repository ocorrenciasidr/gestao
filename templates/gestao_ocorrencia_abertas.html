<!-- gestao_ocorrencia_abertas.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestão de Ocorrências Abertas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'dark-primary': '#0F172A',
            'dark-secondary': '#1E293B',
            'accent': '#10B981',
            'text-light': '#F8FAFC',
            'danger': '#DC2626',
            'tutor-color': '#007ACC',
            'coord-color': '#F59E0B',
            'gestao-color': '#EF4444',
          },
          fontFamily: { sans: ['Inter', 'sans-serif'] },
        },
      },
    };

    document.addEventListener("DOMContentLoaded", carregarOcorrencias);

    function mostrarMensagem(texto, tipo) {
      const msg = document.getElementById("mensagem-status");
      msg.textContent = texto;
      msg.className = "fixed top-4 right-4 p-4 rounded-lg shadow-xl text-text-light z-50 " +
        (tipo === "success" ? "bg-accent" : tipo === "danger" ? "bg-danger" : "bg-dark-secondary text-yellow-400");
      msg.classList.remove("hidden");
      setTimeout(() => msg.classList.add("hidden"), 4000);
    }

    function renderizarAcoes(oc) {
      const id = oc.id || oc.numero;
      let html = `<div class='flex items-center space-x-3'>
          <a href="/gestao_ocorrencia_editar?id=${id}" title="Visualizar"
             class="text-gray-400 hover:text-accent transition">
             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                     d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
             </svg>
          </a>`;

      let indicadores = "";
      const solicitadoT = oc.solicitado_tutor == true || oc.solicitado_tutor == "true" || oc.solicitado_tutor == 1;
      const solicitadoC = oc.solicitado_coordenacao == true || oc.solicitado_coordenacao == "true" || oc.solicitado_coordenacao == 1;
      const solicitadoG = oc.solicitado_gestao == true || oc.solicitado_gestao == "true" || oc.solicitado_gestao == 1;

      const atendT = (oc.atendimento_tutor || "").trim();
      const atendC = (oc.atendimento_coordenacao || "").trim();
      const atendG = (oc.atendimento_gestao || "").trim();

      if (solicitadoT && atendT === "")
        indicadores += `<a href="/gestao_ocorrencia_editar?id=${id}&nivel=T"
          class="bg-tutor-color/20 text-tutor-color text-xs font-bold px-2 py-1 rounded-full border border-tutor-color hover:bg-tutor-color hover:text-white transition">T</a>`;

      if (solicitadoC && atendC === "")
        indicadores += `<a href="/gestao_ocorrencia_editar?id=${id}&nivel=C"
          class="bg-coord-color/20 text-coord-color text-xs font-bold px-2 py-1 rounded-full border border-coord-color hover:bg-coord-color hover:text-white transition">C</a>`;

      if (solicitadoG && atendG === "")
        indicadores += `<a href="/gestao_ocorrencia_editar?id=${id}&nivel=G"
          class="bg-gestao-color/20 text-gestao-color text-xs font-bold px-2 py-1 rounded-full border border-gestao-color hover:bg-gestao-color hover:text-white transition">G</a>`;

      if (indicadores) html += `<div class="ml-4 space-x-2">${indicadores}</div>`;
      html += "</div>";
      return html;
    }

    async function carregarOcorrencias() {
      mostrarMensagem("Carregando ocorrências...", "info");
      const corpo = document.getElementById("ocorrencias-corpo");
      corpo.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-yellow-400">Buscando dados...</td></tr>`;
      try {
        const r = await fetch("/api/ocorrencias_abertas");
        const data = await r.json();
        corpo.innerHTML = "";
        if (!data.length)
          return corpo.innerHTML = `<tr><td colspan="7" class="text-center py-6 text-gray-400">Nenhuma ocorrência.</td></tr>`;

        data.forEach(o => {
          corpo.innerHTML += `
            <tr class="hover:bg-dark-secondary/50">
              <td class="p-3 text-sm">${o.numero}</td>
              <td class="p-3 text-sm">${o.data_hora || ""}</td>
              <td class="p-3 text-sm">${o.aluno_nome || ""}</td>
              <td class="p-3 text-sm">${o.sala_nome || ""}</td>
              <td class="p-3 text-sm">${o.professor_nome || ""}</td>
              <td class="p-3 text-sm">${o.tutor_nome || ""}</td>
              <td class="p-3 text-sm">${renderizarAcoes(o)}</td>
            </tr>`;
        });
        mostrarMensagem(`Carregadas ${data.length} ocorrências.`, "success");
      } catch (e) {
        corpo.innerHTML = `<tr><td colspan="7" class="text-center py-6 text-red-400">Erro ao carregar</td></tr>`;
        mostrarMensagem("Erro ao carregar lista.", "danger");
      }
    }
  </script>
</head>
<body class="bg-dark-primary min-h-screen p-8 text-text-light">
  <div id="mensagem-status" class="hidden"></div>
  <div class="max-w-7xl mx-auto">
    <header class="text-center mb-8 mt-4">
      <h1 class="text-2xl font-light border-b border-gray-700 pb-2 inline-block">
        SISTEMA DE GESTÃO DE CONVIVÊNCIA ESCOLAR
      </h1><br>
      <h2 class="text-lg font-light border-b border-gray-700 pb-2 inline-block">
        GESTÃO DE OCORRÊNCIAS - ABERTAS
      </h2>
      <button onclick="window.location.href='/gestao_ocorrencia'"
        class="mt-4 px-4 py-2 text-sm rounded-lg border border-gray-600 hover:bg-gray-700 flex items-center mx-auto">
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 6h16M4 12h16M4 18h7"/>
        </svg> Voltar ao Menu
      </button>
    </header>

    <main class="overflow-x-auto bg-dark-secondary rounded-xl shadow-2xl p-4">
      <table class="min-w-full divide-y divide-gray-700">
        <thead class="bg-dark-primary">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Número</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Data Reg.</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Aluno</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Sala</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Professor</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Tutor</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Ações</th>
          </tr>
        </thead>
        <tbody id="ocorrencias-corpo" class="divide-y divide-gray-800">
          <tr><td colspan="7" class="text-center py-4 text-gray-400">Carregando...</td></tr>
        </tbody>
      </table>
    </main>

    <footer class="w-full text-center mt-10 p-4 text-gray-400 text-sm border-t border-gray-800">
      <p class="text-base font-medium">DESENVOLVEDOR: MARCELO ANDRÉ NOGUEIRA CARDES</p>
      <p class="text-xs font-light">LICENCIADO: E.E. PEI PROFESSORA IRENE DIAS RIBEIRO</p>
    </footer>
  </div>
</body>
</html>
