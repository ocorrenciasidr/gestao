<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Relatório Estatístico</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { background-color: #0F172A; color: #F8FAFC; font-family: sans-serif; }
.card { background-color: #1E293B; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; }
h2 { color: #10B981; margin-bottom: 1rem; }
table { width: 100%; border-collapse: collapse; margin-bottom: 2rem; }
th, td { border: 1px solid #334155; padding: 0.5rem; text-align: left; }
th { background-color: #334155; }
canvas { background-color: #1E293B; border-radius: 0.5rem; }
</style>
</head>
<body class="p-4 md:p-8">

<div class="max-w-6xl mx-auto">

    <header class="mb-6 text-center">
        <h1 class="text-3xl font-bold text-accent">Relatório Estatístico de Ocorrências</h1>
    </header>

    <!-- Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="card text-center">
            <h2>Total Ocorrências</h2>
            <p id="total-ocorrencias" class="text-2xl font-bold">0</p>
        </div>
        <div class="card text-center">
            <h2>Ocorrências Abertas</h2>
            <p id="abertas-ocorrencias" class="text-2xl font-bold">0</p>
        </div>
        <div class="card text-center">
            <h2>Ocorrências Finalizadas</h2>
            <p id="finalizadas-ocorrencias" class="text-2xl font-bold">0</p>
        </div>
    </div>

    <!-- Resumo Geral -->
    <div class="card">
        <h2>Resumo Geral por Tipo</h2>
        <table>
            <thead>
                <tr>
                    <th>Tipo</th>
                    <th>Qtd</th>
                    <th>%</th>
                </tr>
            </thead>
            <tbody id="tabela-resumo-geral"></tbody>
        </table>
        <canvas id="chart-tipo" height="180"></canvas>
    </div>

    <!-- Ocorrências por Sala -->
    <div class="card">
        <h2>Ocorrências por Sala</h2>
        <table>
            <thead>
                <tr>
                    <th>Sala</th>
                    <th>Total</th>
                    <th>% do Total</th>
                    <th>Menos 7 dias</th>
                    <th>Mais 7 dias</th>
                    <th>Não Respondidas</th>
                </tr>
            </thead>
            <tbody id="tabela-por-sala"></tbody>
        </table>
        <canvas id="chart-respostas" height="180"></canvas>
    </div>

    <!-- Ocorrências por Tutor -->
    <div class="card">
        <h2>Ocorrências por Tutor</h2>
        <table>
            <thead>
                <tr>
                    <th>Tutor</th>
                    <th>Total</th>
                    <th>Finalizadas</th>
                    <th>Abertas</th>
                    <th>Média Dias Resposta</th>
                </tr>
            </thead>
            <tbody id="tabela-por-tutor"></tbody>
        </table>
        <canvas id="chart-tutor" height="180"></canvas>
    </div>

    <!-- Ocorrências por Mês -->
    <div class="card">
        <h2>Ocorrências por Mês</h2>
        <canvas id="chart-mes" height="180"></canvas>
    </div>

    <div id="mensagem-status" class="hidden p-3 mb-4 text-sm font-medium text-white rounded-lg" role="alert"></div>

</div>

<script>
// JS para relatório estatístico de ocorrências

let chartRespostas = null;
let chartTutor = null;
let chartTipo = null;
let chartMes = null;

async function carregarEstatisticas() {
    try {
        const response = await fetch('/api/relatorio_estatistico');
        const data = await response.json();

        document.getElementById('total-ocorrencias').textContent = data.total ?? 0;
        document.getElementById('abertas-ocorrencias').textContent = data.abertas ?? 0;
        document.getElementById('finalizadas-ocorrencias').textContent = data.finalizadas ?? 0;

        const total = data.total ?? 1;
        const tipos = data.tipos ?? {};
        let resumoHTML = "";
        Object.entries(tipos).forEach(([tipo, count]) => {
            const pct = ((count / total) * 100).toFixed(1);
            resumoHTML += `<tr>
                <td>${tipo}</td>
                <td>${count}</td>
                <td>${pct}%</td>
            </tr>`;
        });
        document.getElementById('tabela-resumo-geral').innerHTML = resumoHTML;

        if(Array.isArray(data.por_sala)) {
            let porSalaHTML = "";
            data.por_sala.forEach(item => {
                const pct = ((item.total / total) * 100).toFixed(1);
                porSalaHTML += `<tr>
                    <td>${item.sala || 'Indefinida'}</td>
                    <td>${item.total}</td>
                    <td>${pct}%</td>
                    <td>${item.menos_7d ?? '-'}</td>
                    <td>${item.mais_7d ?? '-'}</td>
                    <td>${item.nao_respondidas ?? '-'}</td>
                </tr>`;
            });
            document.getElementById('tabela-por-sala').innerHTML = porSalaHTML;
        }

        if(Array.isArray(data.por_tutor)) {
            let porTutorHTML = "";
            data.por_tutor.forEach(item => {
                porTutorHTML += `<tr>
                    <td>${item.tutor || 'Indefinido'}</td>
                    <td>${item.total}</td>
                    <td>${item.finalizadas}</td>
                    <td>${item.abertas}</td>
                    <td>${item.media_dias_resposta ?? '-'}</td>
                </tr>`;
            });
            document.getElementById('tabela-por-tutor').innerHTML = porTutorHTML;
        }

        if(data.tempo_resposta?.labels?.length && data.tempo_resposta?.valores?.length) criarGraficoRespostas(data.tempo_resposta);
        if(Array.isArray(data.por_tutor) && data.por_tutor.length > 0) criarGraficoTutor(data.por_tutor);
        if(Object.keys(tipos).length > 0) criarGraficoTipo(tipos);
        if(data.ocorrencias_por_mes?.labels?.length && data.ocorrencias_por_mes?.valores?.length) criarGraficoPorMes(data.ocorrencias_por_mes);

    } catch(err) {
        const msgEl = document.getElementById('mensagem-status');
        msgEl.classList.remove('hidden');
        msgEl.textContent = 'Erro ao carregar estatísticas: ' + err;
    }
}

function gerarCores(n) {
    const cores = [];
    for(let i=0;i<n;i++){
        const r = Math.floor(Math.random()*200)+50;
        const g = Math.floor(Math.random()*200)+50;
        const b = Math.floor(Math.random()*200)+50;
        cores.push(`rgba(${r},${g},${b},0.7)`);
    }
    return cores;
}

function criarGraficoRespostas(tempo_resposta){
    const el = document.getElementById('chart-respostas');
    if(!el) return;
    if(chartRespostas) chartRespostas.destroy();
    chartRespostas = new Chart(el.getContext('2d'), {
        type:'bar',
        data:{labels:tempo_resposta.labels,datasets:[{label:'Qtd Ocorrências',data:tempo_resposta.valores,backgroundColor:'rgba(99,102,241,0.6)'}]},
        options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{title:{display:true,text:'Faixa de Dias'}},y:{beginAtZero:true}}}
    });
}

function criarGraficoTutor(por_tutor){
    const el = document.getElementById('chart-tutor');
    if(!el) return;
    if(chartTutor) chartTutor.destroy();
    chartTutor = new Chart(el.getContext('2d'), {
        type:'pie',
        data:{labels:por_tutor.map(x=>x.tutor),datasets:[{data:por_tutor.map(x=>x.total),backgroundColor:gerarCores(por_tutor.length)}]},
        options:{plugins:{legend:{position:'bottom'}}}
    });
}

function criarGraficoTipo(tipos){
    const el = document.getElementById('chart-tipo');
    if(!el) return;
    if(chartTipo) chartTipo.destroy();
    chartTipo = new Chart(el.getContext('2d'), {
        type:'pie',
        data:{labels:Object.keys(tipos),datasets:[{data:Object.values(tipos),backgroundColor:gerarCores(Object.keys(tipos).length)}]},
        options:{plugins:{legend:{position:'bottom'}}}
    });
}

function criarGraficoPorMes(ocorrencias_por_mes){
    const el = document.getElementById('chart-mes');
    if(!el) return;
    if(chartMes) chartMes.destroy();
    chartMes = new Chart(el.getContext('2d'), {
        type:'bar',
        data:{labels:ocorrencias_por_mes.labels,datasets:[{label:'Ocorrências por Mês',data:ocorrencias_por_mes.valores,backgroundColor:'rgba(251,191,36,0.7)'}]},
        options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{title:{display:true,text:'Mês'}},y:{beginAtZero:true}}}
    });
}

window.addEventListener('DOMContentLoaded', carregarEstatisticas);
</script>

</body>
</html>
