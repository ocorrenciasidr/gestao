<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ocorrências Finalizadas</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        'dark-primary':'#0F172A',
        'dark-secondary':'#1E293B',
        'accent':'#10B981',
        'text-light':'#F8FAFC',
        'tutor-color':'#007ACC',
        'coord-color':'#F59E0B',
        'gestao-color':'#EF4444'
      }
    }
  }
};

document.addEventListener('DOMContentLoaded', () => {
  carregarFiltros();
  carregarOcorrencias();

  // Auto filtragem — dispara sempre que o usuário muda um filtro
  document.getElementById('filtro-sala').addEventListener('change', carregarOcorrencias);
  document.getElementById('filtro-aluno').addEventListener('change', carregarOcorrencias);
});

// Mostra mensagens simples no canto superior
function mostrarMensagem(texto, tipo = 'info') {
  const el = document.getElementById('mensagem-status');
  el.textContent = texto;
  el.className = 'fixed top-4 right-4 p-3 rounded z-50 text-text-light';
  if (tipo === 'success') el.style.background = '#10B981';
  else if (tipo === 'danger') el.style.background = '#DC2626';
  else el.style.background = '#1E293B';
  setTimeout(()=> el.textContent = '', 3000);
}

// Carrega lista de salas e alunos
async function carregarFiltros() {
  try {
    const [rS, rA] = await Promise.all([fetch('/api/salas'), fetch('/api/alunos')]);
    const salas = rS.ok ? await rS.json() : [];
    const alunos = rA.ok ? await rA.json() : [];

    const selSala = document.getElementById('filtro-sala');
    selSala.innerHTML = '<option value="">Todas as Salas</option>';
    salas.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.nome || s.sala_nome || s.id;
      opt.text = s.nome || s.sala_nome || `Sala ${s.id}`;
      selSala.appendChild(opt);
    });

    const selAluno = document.getElementById('filtro-aluno');
    selAluno.innerHTML = '<option value="">Todos os Alunos</option>';
    alunos.forEach(a => {
      const opt = document.createElement('option');
      opt.value = a.nome || a.aluno_nome || a.id;
      opt.text = a.nome || a.aluno_nome || `Aluno ${a.id}`;
      selAluno.appendChild(opt);
    });

  } catch (e) {
    console.error('Erro filtros:', e);
    mostrarMensagem('Falha ao carregar filtros', 'danger');
  }
}

// Ícones de ação
function renderizarAcoes(occ) {
  const numero = occ.numero;
  let html = `<div class="flex items-center space-x-2">
    <a href="/gestao_ocorrencia_editar?id=${numero}&modo=visualizar" title="Visualizar" class="text-gray-400 hover:text-accent">
      <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
      </svg>
    </a>`;

  // conversões seguras
  const st = occ.solicitado_tutor === true || occ.solicitado_tutor === 'true' || occ.solicitado_tutor === 1;
  const sc = occ.solicitado_coordenacao === true || occ.solicitado_coordenacao === 'true' || occ.solicitado_coordenacao === 1;
  const sg = occ.solicitado_gestao === true || occ.solicitado_gestao === 'true' || occ.solicitado_gestao === 1;

  const at = (occ.atendimento_tutor || '').trim();
  const ac = (occ.atendimento_coordenacao || '').trim();
  const ag = (occ.atendimento_gestao || '').trim();

  if (st && at === '') html += `<span class="text-xs font-bold px-2 py-0.5 rounded-full border border-tutor-color bg-tutor-color/10 text-tutor-color">T</span>`;
  if (sc && ac === '') html += `<span class="text-xs font-bold px-2 py-0.5 rounded-full border border-coord-color bg-coord-color/10 text-coord-color">C</span>`;
  if (sg && ag === '') html += `<span class="text-xs font-bold px-2 py-0.5 rounded-full border border-gestao-color bg-gestao-color/10 text-gestao-color">G</span>`;

  html += '</div>';
  return html;
}

// Busca as ocorrências finalizadas
async function carregarOcorrencias() {
  mostrarMensagem('Carregando...', 'info');
  const tabela = document.getElementById('ocorrencias-corpo');
  tabela.innerHTML = '<tr><td colspan="6" class="py-6 text-center text-gray-400">Carregando...</td></tr>';

  const sala = encodeURIComponent(document.getElementById('filtro-sala').value || '');
  const aluno = encodeURIComponent(document.getElementById('filtro-aluno').value || '');
  let url = '/api/ocorrencias_finalizadas';
  const params = [];
  if (sala) params.push(`sala=${sala}`);
  if (aluno) params.push(`aluno=${aluno}`);
  if (params.length) url += '?' + params.join('&');

  try {
    const resp = await fetch(url);
    if (!resp.ok) throw new Error('Falha ao buscar finalizadas');
    const data = await resp.json();
    if (!Array.isArray(data) || data.length === 0) {
      tabela.innerHTML = '<tr><td colspan="6" class="py-6 text-center text-gray-400">Nenhuma ocorrência finalizada.</td></tr>';
      return;
    }
    let html = '';
    data.forEach(occ => {
      html += `<tr class="hover:bg-dark-secondary/50">
        <td class="p-3 text-sm font-medium text-text-light">${occ.numero}</td>
        <td class="p-3 text-sm text-gray-300">${occ.aluno_nome || ''}</td>
        <td class="p-3 text-sm text-gray-300">${occ.sala_nome || occ.sala || ''}</td>
        <td class="p-3 text-sm text-gray-300">${occ.tutor_nome || ''}</td>
        <td class="p-3 text-sm text-gray-300">${occ.status || ''}</td>
        <td class="p-3 text-sm whitespace-nowrap">${renderizarAcoes(occ)}</td>
      </tr>`;
    });
    tabela.innerHTML = html;
    mostrarMensagem('Finalizadas carregadas', 'success');
  } catch (e) {
    console.error(e);
    tabela.innerHTML = '<tr><td colspan="6" class="py-6 text-center text-red-400">Erro ao carregar.</td></tr>';
    mostrarMensagem('Erro ao carregar finalizadas', 'danger');
  }
}
</script>
</head>

<body class="bg-dark-primary min-h-screen p-6 text-text-light">

<!-- Cabeçalho Padronizado -->
<header class="text-center mb-8 mt-4">
  <h1 class="text-2xl text-text-light mt-2 font-light border-b border-gray-700 pb-2 inline-block">
    SISTEMA DE GESTÃO DE CONVIVÊNCIA ESCOLAR
  </h1><br>
  <h2 class="text-lg text-text-light mt-2 font-light border-b border-gray-700 pb-2 inline-block">
    GESTÃO DE OCORRÊNCIAS - OCORRÊNCIAS FINALIZADAS
  </h2>
  <button onclick="window.location.href='/gestao_ocorrencia'"
    class="mt-4 px-4 py-2 text-sm font-medium rounded-lg text-gray-300 border border-gray-600
           hover:bg-gray-700 transition duration-150 flex items-center mx-auto">
    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M4 6h16M4 12h16M4 18h7"></path>
    </svg>
    Voltar ao Menu de Ocorrências
  </button>
</header>

<!-- Mensagem de status -->
<div id="mensagem-status" class="hidden fixed top-4 right-4 p-3 rounded z-50 text-text-light"></div>

<!-- Conteúdo principal -->
<main class="max-w-7xl mx-auto bg-dark-secondary p-6 rounded-lg shadow-2xl">
  <div class="flex flex-wrap justify-center gap-4 mb-4">
    <select id="filtro-sala" class="px-3 py-2 rounded bg-white text-black"></select>
    <select id="filtro-aluno" class="px-3 py-2 rounded bg-white text-black"></select>
  </div>

  <div class="overflow-x-auto">
    <table class="w-full border-collapse">
      <thead class="text-xs text-gray-400 border-b border-gray-700">
        <tr>
          <th class="text-left p-2">Número</th>
          <th class="text-left p-2">Aluno</th>
          <th class="text-left p-2">Sala</th>
          <th class="text-left p-2">Tutor</th>
          <th class="text-left p-2">Status</th>
          <th class="text-left p-2">Ações</th>
        </tr>
      </thead>
      <tbody id="ocorrencias-corpo" class="divide-y">
        <tr><td colspan="6" class="py-6 text-center text-gray-400">Carregando dados...</td></tr>
      </tbody>
    </table>
  </div>
</main>

<!-- Rodapé Padronizado -->
<footer class="w-full text-center mt-10 p-4 text-gray-400 text-sm border-t border-gray-800">
  <p class="mb-1 text-base font-medium">
    DESENVOLVEDOR: MARCELO ANDRÉ NOGUEIRA CARDES
  </p>
  <p class="text-xs font-light tracking-wide">
    LICENCIADO: E.E. PEI PROFESSORA IRENE DIAS RIBEIRO
  </p>
</footer>

</body>
</html>
