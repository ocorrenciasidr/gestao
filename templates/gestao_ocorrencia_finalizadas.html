<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ocorrências Finalizadas</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        'dark-primary':'#0F172A',
        'dark-secondary':'#1E293B',
        'accent':'#10B981',
        'text-light':'#F8FAFC',
        'tutor-color':'#007ACC',
        'coord-color':'#F59E0B',
        'gestao-color':'#EF4444'
      }
    }
  }
};

let ocorrenciasFinalizadas = []; // Armazena a lista completa de ocorrências

document.addEventListener('DOMContentLoaded', () => {
  carregarDadosEFiltros(); // Nova função para carregar dados e popular filtros

  // Auto filtragem — dispara sempre que o usuário muda um filtro
  document.getElementById('filtro-sala').addEventListener('change', () => {
    popularFiltroAlunos(document.getElementById('filtro-sala').value); // 1. Filtra alunos
    carregarOcorrencias(); // 2. Recarrega a tabela
  });
  document.getElementById('filtro-aluno').addEventListener('change', carregarOcorrencias); // 3. Recarrega a tabela
});

// Mostra mensagens simples no canto superior
function mostrarMensagem(texto, tipo = 'info') {
  const el = document.getElementById('mensagem-status');
  el.textContent = texto;
  el.className = 'fixed top-4 right-4 p-3 rounded z-50 text-text-light';
  if (tipo === 'success') el.style.background = '#10B981';
  else if (tipo === 'danger') el.style.background = '#DC2626';
  else el.style.background = '#1E293B';
  setTimeout(()=> el.textContent = '', 3000);
}

// 1. Nova função: Carrega a lista completa de ocorrências E popular os filtros
async function carregarDadosEFiltros() {
  mostrarMensagem('Carregando dados...', 'info');
  try {
    // Usando a API original para buscar os dados de ocorrências finalizadas
    const resp = await fetch('/api/ocorrencias_finalizadas'); 
    if (!resp.ok) throw new Error('Falha ao buscar finalizadas');
    ocorrenciasFinalizadas = await resp.json();

    popularFiltroSalas();
    popularFiltroAlunos(); // Inicialmente, popula com todos os alunos
    carregarOcorrencias(); // Carrega a tabela inicial
    mostrarMensagem('Dados e filtros carregados', 'success');

  } catch (e) {
    console.error('Erro ao carregar dados:', e);
    mostrarMensagem('Falha ao carregar dados iniciais', 'danger');
    const tabela = document.getElementById('ocorrencias-corpo');
    tabela.innerHTML = '<tr><td colspan="6" class="py-6 text-center text-red-400">Erro ao carregar dados.</td></tr>';
  }
}

// 2. Popula o filtro de Salas usando a lista de ocorrências finalizadas
function popularFiltroSalas() {
  const selSala = document.getElementById('filtro-sala');
  selSala.innerHTML = '<option value="">Todas as Salas</option>';
  
  // Extrai salas únicas das ocorrências finalizadas
  const salasUnicas = new Set(ocorrenciasFinalizadas.map(occ => occ.sala_nome || occ.sala).filter(Boolean));
  
  salasUnicas.forEach(salaNome => {
    const opt = document.createElement('option');
    opt.value = salaNome;
    opt.text = salaNome;
    selSala.appendChild(opt);
  });
}

// 3. Popula ou repopula o filtro de Alunos (encadeado)
function popularFiltroAlunos(salaFiltro = '') {
  const selAluno = document.getElementById('filtro-aluno');
  const valorAtualAluno = selAluno.value; 
  
  selAluno.innerHTML = '<option value="">Todos os Alunos</option>';

  // Filtra as ocorrências pela sala selecionada (se houver)
  const ocorrenciasFiltradas = salaFiltro 
    ? ocorrenciasFinalizadas.filter(occ => (occ.sala_nome || occ.sala) === salaFiltro) 
    : ocorrenciasFinalizadas;

  // Extrai alunos únicos das ocorrências filtradas
  const alunosMap = new Map(); 
  ocorrenciasFiltradas.forEach(occ => {
    if (occ.aluno_nome) {
      alunosMap.set(occ.aluno_nome, occ.aluno_nome);
    }
  });

  alunosMap.forEach((nome, valor) => {
    const opt = document.createElement('option');
    opt.value = valor;
    opt.text = nome;
    selAluno.appendChild(opt);
  });
  
  // Tenta manter a seleção do aluno anterior
  if (valorAtualAluno && alunosMap.has(valorAtualAluno)) {
     selAluno.value = valorAtualAluno;
  }
}

// Ícones de ação (função inalterada)
function renderizarAcoes(occ) {
  const numero = occ.numero;
  let html = `<div class="flex items-center space-x-2">
    <a href="/gestao_ocorrencia_editar?id=${numero}&modo=visualizar" title="Visualizar" class="text-gray-400 hover:text-accent">
      <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
      </svg>
    </a>`;

  // conversões seguras
  const st = occ.solicitado_tutor === true || occ.solicitado_tutor === 'true' || occ.solicitado_tutor === 1;
  const sc = occ.solicitado_coordenacao === true || occ.solicitado_coordenacao === 'true' || occ.solicitado_coordenacao === 1;
  const sg = occ.solicitado_gestao === true || occ.solicitado_gestao === 'true' || occ.solicitado_gestao === 1;

  const at = (occ.atendimento_tutor || '').trim();
  const ac = (occ.atendimento_coordenacao || '').trim();
  const ag = (occ.atendimento_gestao || '').trim();

  if (st && at === '') html += `<span class="text-xs font-bold px-2 py-0.5 rounded-full border border-tutor-color bg-tutor-color/10 text-tutor-color">T</span>`;
  if (sc && ac === '') html += `<span class="text-xs font-bold px-2 py-0.5 rounded-full border border-coord-color bg-coord-color/10 text-coord-color">C</span>`;
  if (sg && ag === '') html += `<span class="text-xs font-bold px-2 py-0.5 rounded-full border border-gestao-color bg-gestao-color/10 text-gestao-color">G</span>`;

  html += '</div>';
  return html;
}

// 4. Busca e renderiza as ocorrências (agora usa a lista local `ocorrenciasFinalizadas` e os filtros)
function carregarOcorrencias() {
  const tabela = document.getElementById('ocorrencias-corpo');
  tabela.innerHTML = '<tr><td colspan="6" class="py-6 text-center text-gray-400">Filtrando dados...</td></tr>';

  const filtroSala = document.getElementById('filtro-sala').value;
  const filtroAluno = document.getElementById('filtro-aluno').value;

  // Filtra a lista local com base nos filtros selecionados
  const dadosFiltrados = ocorrenciasFinalizadas.filter(occ => {
    const salaCorrente = occ.sala_nome || occ.sala;
    const alunoCorrente = occ.aluno_nome;
    
    // Filtro por Sala
    const filtroSalaOk = !filtroSala || salaCorrente === filtroSala;
    
    // Filtro por Aluno
    const filtroAlunoOk = !filtroAluno || alunoCorrente === filtroAluno;
    
    return filtroSalaOk && filtroAlunoOk;
  });

  if (dadosFiltrados.length === 0) {
    tabela.innerHTML = '<tr><td colspan="6" class="py-6 text-center text-gray-400">Nenhuma ocorrência finalizada com estes filtros.</td></tr>';
    mostrarMensagem('Filtros aplicados. Nenhuma ocorrência encontrada.', 'info');
    return;
  }
  
  let html = '';
  dadosFiltrados.forEach(occ => {
    html += `<tr class="hover:bg-dark-secondary/50">
      <td class="p-3 text-sm font-medium text-text-light">${occ.numero}</td>
      <td class="p-3 text-sm text-gray-300">${occ.aluno_nome || ''}</td>
      <td class="p-3 text-sm text-gray-300">${occ.sala_nome || occ.sala || ''}</td>
      <td class="p-3 text-sm text-gray-300">${occ.tutor_nome || ''}</td>
      <td class="p-3 text-sm text-gray-300">${occ.status || ''}</td>
      <td class="p-3 text-sm whitespace-nowrap">${renderizarAcoes(occ)}</td>
    </tr>`;
  });
  tabela.innerHTML = html;
  mostrarMensagem(`Ocorrências carregadas: ${dadosFiltrados.length}`, 'success');
}
</script>
</head>

<body class="bg-dark-primary min-h-screen p-6 text-text-light">

<header class="text-center mb-8 mt-4">
  <h1 class="text-2xl text-text-light mt-2 font-light border-b border-gray-700 pb-2 inline-block">
    SISTEMA DE GESTÃO DE CONVIVÊNCIA ESCOLAR
  </h1><br>
  <h2 class="text-lg text-text-light mt-2 font-light border-b border-gray-700 pb-2 inline-block">
    GESTÃO DE OCORRÊNCIAS - OCORRÊNCIAS FINALIZADAS
  </h2>
  <button onclick="window.location.href='/gestao_ocorrencia'"
    class="mt-4 px-4 py-2 text-sm font-medium rounded-lg text-gray-300 border border-gray-600
           hover:bg-gray-700 transition duration-150 flex items-center mx-auto">
    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M4 6h16M4 12h16M4 18h7"></path>
    </svg>
    Voltar ao Menu de Ocorrências
  </button>
</header>

<div id="mensagem-status" class="hidden fixed top-4 right-4 p-3 rounded z-50 text-text-light"></div>

<main class="max-w-7xl mx-auto bg-dark-secondary p-6 rounded-lg shadow-2xl">
  <div class="flex flex-wrap justify-center gap-4 mb-4">
    <select id="filtro-sala" class="px-3 py-2 rounded bg-white text-black"></select>
    <select id="filtro-aluno" class="px-3 py-2 rounded bg-white text-black"></select>
  </div>

  <div class="overflow-x-auto">
    <table class="w-full border-collapse">
      <thead class="text-xs text-gray-400 border-b border-gray-700">
        <tr>
          <th class="text-left p-2">Número</th>
          <th class="text-left p-2">Aluno</th>
          <th class="text-left p-2">Sala</th>
          <th class="text-left p-2">Tutor</th>
          <th class="text-left p-2">Status</th>
          <th class="text-left p-2">Ações</th>
        </tr>
      </thead>
      <tbody id="ocorrencias-corpo" class="divide-y">
        <tr><td colspan="6" class="py-6 text-center text-gray-400">Carregando dados...</td></tr>
      </tbody>
    </table>
  </div>
</main>

<footer class="w-full text-center mt-10 p-4 text-gray-400 text-sm border-t border-gray-800">
  <p class="mb-1 text-base font-medium">
    DESENVOLVEDOR: MARCELO ANDRÉ NOGUEIRA CARDES
  </p>
  <p class="text-xs font-light tracking-wide">
    LICENCIADO: E.E. PEI PROFESSORA IRENE DIAS RIBEIRO
  </p>
</footer>

</body>
</html>
