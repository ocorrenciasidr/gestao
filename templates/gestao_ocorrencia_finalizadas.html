<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Ocorrências Finalizadas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { /* ... seu config ... */ };
    </script>
    <style>
        /* ... seus estilos ... */
    </style>
    <script>
        let finalizadasOcorrencias = [];
        let idOcorrenciaParaExcluir = null;
        const GESTAO_SENHA_MOCK = 'idrgestao';

        document.addEventListener('DOMContentLoaded', loadOcorrencias);

        // =====> FUNÇÃO DE FETCH "SUPER DETETIVE" <=====
        async function handleFetchResponse(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const errorDetails = await response.text();
                    throw new Error(`A API respondeu com erro!\n\nStatus: ${response.status} (${response.statusText})\nURL: ${url}\n\nO servidor respondeu com uma página HTML em vez de dados JSON. Isso geralmente indica um redirecionamento para a página de login.`);
                }
                // Adicionamos uma verificação extra para garantir que a resposta é JSON
                const text = await response.text();
                try {
                    return JSON.parse(text);
                } catch (e) {
                    throw new Error(`A API não retornou um JSON válido, mesmo com status OK.\nResposta recebida:\n${text.substring(0, 100)}...`);
                }

            } catch (networkError) {
                throw new Error(`Erro de Conexão de Rede.\n\nVerifique se o servidor está rodando e a URL está correta.\nDetalhes: ${networkError.message}`);
            }
        }
        
        async function loadOcorrencias() {
            mostrarMensagem('Carregando histórico do servidor...', 'warning');
            const tbody = document.getElementById('tabela-ocorrencias');
            try {
                // Chamando a rota específica com a nossa nova função de fetch
                finalizadasOcorrencias = await handleFetchResponse('/api/ocorrencias_finalizadas');
                
                preencherFiltrosEstaticos(finalizadasOcorrencias);
                aplicarFiltros(); // aplicarFiltros já chama renderizarTabela
                mostrarMensagem('Histórico carregado.', 'success');
                
            } catch (error) {
                console.error("Erro ao carregar histórico:", error);
                mostrarMensagem(`Erro ao carregar lista.`, 'danger');
                // Exibe o erro super detalhado diretamente na tabela
                tbody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-danger whitespace-pre-wrap">${error.message}</td></tr>`;
                // E também em um alert para garantir a visualização
                alert(error.message);
            }
        }

        function mostrarMensagem(texto, tipo) { /* ...código sem alteração... */ }
        function formatarData(dataString) { /* ...código sem alteração... */ }
        function exibirDataOuTraco(dataAtendimento, isSolicitado) { /* ...código sem alteração... */ }
        function preencherFiltrosEstaticos(ocorrencias) { /* ...código sem alteração... */ }
        window.preencherFiltroAluno = function() { /* ...código sem alteração... */ }
        window.aplicarFiltros = function() { /* ...código sem alteração... */ }
        function abrirModalSenhaEdicao(ocorrenciaId) { /* ...código sem alteração... */ }
        function validarSenha(event) { /* ...código sem alteração... */ }
        function confirmarExclusao(id) { /* ...código sem alteração... */ }
        async function excluirOcorrencia() { /* ...código sem alteração... */ }
        function renderizarTabela(ocorrencias) { /* ...código sem alteração... */ }
    </script>
</head>
<body class="bg-dark-primary font-sans text-text-light">
    </body>
</html>
