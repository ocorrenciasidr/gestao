<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OcorrÃªncias Finalizadas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'dark-primary': '#0F172A',
            'dark-secondary': '#1E293B',
            'accent': '#10B981',
            'text-light': '#F8FAFC',
            'danger': '#DC2626',
            'tutor-color': '#007ACC',
            'coord-color': '#F59E0B',
            'gestao-color': '#EF4444',
          },
          fontFamily: { sans: ['Inter', 'sans-serif'] },
        },
      },
    };

    document.addEventListener("DOMContentLoaded", carregarOcorrencias);

    let todasOcorrencias = [];

    // Exibe mensagens
    function mostrarMensagem(texto, tipo) {
      const msg = document.getElementById("mensagem-status");
      msg.textContent = texto;
      msg.className = "fixed top-4 right-4 p-3 rounded-lg shadow-xl text-text-light font-medium transition duration-300 z-50";

      if (tipo === "success") msg.classList.add("bg-accent");
      else if (tipo === "danger") msg.classList.add("bg-danger");
      else msg.classList.add("bg-dark-secondary", "text-yellow-400");

      msg.classList.remove("hidden");
      setTimeout(() => msg.classList.add("hidden"), 4000);
    }

    // LÃ³gica T / C / G
    function renderizarAcoes(ocorrencia) {
      const numero = ocorrencia.numero;
      let html = `
        <div class="flex items-center space-x-3">
          <a href="/gestao_ocorrencia_editar?id=${numero}&modo=visualizar" title="Visualizar"
            class="text-gray-400 hover:text-accent transition duration-150">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </a>`;

      let indicadores = "";

      if (ocorrencia.solicitado_tutor && (!ocorrencia.atendimento_tutor || ocorrencia.atendimento_tutor.trim() === "")) {
        indicadores += `<a href="/gestao_ocorrencia_editar?id=${numero}&modo=atendimento&nivel=tutor"
          class="bg-tutor-color/20 text-tutor-color text-xs font-bold px-2 py-1 rounded-full border border-tutor-color hover:bg-tutor-color hover:text-white transition">T</a>`;
      }
      if (ocorrencia.solicitado_coordenacao && (!ocorrencia.atendimento_coordenacao || ocorrencia.atendimento_coordenacao.trim() === "")) {
        indicadores += `<a href="/gestao_ocorrencia_editar?id=${numero}&modo=atendimento&nivel=coordenacao"
          class="bg-coord-color/20 text-coord-color text-xs font-bold px-2 py-1 rounded-full border border-coord-color hover:bg-coord-color hover:text-white transition">C</a>`;
      }
      if (ocorrencia.solicitado_gestao && (!ocorrencia.atendimento_gestao || ocorrencia.atendimento_gestao.trim() === "")) {
        indicadores += `<a href="/gestao_ocorrencia_editar?id=${numero}&modo=atendimento&nivel=gestao"
          class="bg-gestao-color/20 text-gestao-color text-xs font-bold px-2 py-1 rounded-full border border-gestao-color hover:bg-gestao-color hover:text-white transition">G</a>`;
      }

      if (indicadores) html += `<div class="ml-4 space-x-2">${indicadores}</div>`;
      html += `</div>`;
      return html;
    }

    // Carregar ocorrÃªncias da API
    async function carregarOcorrencias() {
      const tabela = document.getElementById("ocorrencias-corpo");
      try {
        mostrarMensagem("Carregando ocorrÃªncias finalizadas...", "info");
        const res = await fetch("/api/ocorrencias_finalizadas");
        todasOcorrencias = await res.json();
        popularFiltros(todasOcorrencias);
        exibirOcorrencias(todasOcorrencias);
        mostrarMensagem("OcorrÃªncias carregadas!", "success");
      } catch (e) {
        console.error(e);
        mostrarMensagem("Erro ao carregar ocorrÃªncias.", "danger");
      }
    }

    // Popula filtros de Sala e Aluno
    function popularFiltros(dados) {
      const filtroSala = document.getElementById("filtro-sala");
      const filtroAluno = document.getElementById("filtro-aluno");

      const salasUnicas = [...new Set(dados.map(o => o.sala_nome).filter(Boolean))];
      filtroSala.innerHTML = `<option value="">Todas as Salas</option>` +
        salasUnicas.map(s => `<option value="${s}">${s}</option>`).join("");

      const alunosUnicos = [...new Set(dados.map(o => o.aluno_nome).filter(Boolean))];
      filtroAluno.innerHTML = `<option value="">Todos os Alunos</option>` +
        alunosUnicos.map(a => `<option value="${a}">${a}</option>`).join("");
    }

    function filtrarPorSala() {
      const sala = document.getElementById("filtro-sala").value;
      const filtroAluno = document.getElementById("filtro-aluno");

      let alunos = todasOcorrencias
        .filter(o => !sala || o.sala_nome === sala)
        .map(o => o.aluno_nome)
        .filter(Boolean);
      alunos = [...new Set(alunos)];

      filtroAluno.innerHTML = `<option value="">Todos os Alunos</option>` +
        alunos.map(a => `<option value="${a}">${a}</option>`).join("");

      aplicarFiltros();
    }

    function filtrarPorAluno() { aplicarFiltros(); }

    function aplicarFiltros() {
      const sala = document.getElementById("filtro-sala").value;
      const aluno = document.getElementById("filtro-aluno").value;

      const filtradas = todasOcorrencias.filter(o =>
        (!sala || o.sala_nome === sala) &&
        (!aluno || o.aluno_nome === aluno)
      );

      exibirOcorrencias(filtradas);
    }

    // Renderiza tabela
    function exibirOcorrencias(lista) {
      const corpo = document.getElementById("ocorrencias-corpo");
      if (!lista.length) {
        corpo.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-400">Nenhuma ocorrÃªncia encontrada.</td></tr>`;
        return;
      }

      corpo.innerHTML = lista.map(o => `
        <tr class="hover:bg-dark-secondary/50 transition duration-150">
          <td class="p-3 text-sm font-medium text-text-light">${o.numero}</td>
          <td class="p-3 text-sm text-gray-300">${o.data_hora || ""}</td>
          <td class="p-3 text-sm text-gray-300">${o.aluno_nome || ""}</td>
          <td class="p-3 text-sm text-gray-300">${o.sala_nome || ""}</td>
          <td class="p-3 text-sm text-gray-300">${o.tutor_nome || ""}</td>
          <td class="p-3 text-sm whitespace-nowrap">${renderizarAcoes(o)}</td>
        </tr>`).join("");
    }
  </script>
</head>

<body class="bg-dark-primary min-h-screen p-8 text-text-light">
  <div id="mensagem-status" class="hidden"></div>

  <div class="max-w-7xl mx-auto">
    <header class="text-center mb-8 mt-4">
      <h1 class="text-2xl text-text-light mt-2 font-light border-b border-gray-700 pb-2 inline-block">
        SISTEMA DE GESTÃƒO DE CONVIVÃŠNCIA ESCOLAR </h1><br>
      <h2 class="text-2xl text-text-light mt-2 font-light border-b border-gray-700 pb-2 inline-block">
        GESTÃƒO DE OCORRÃŠNCIAS - OCORRÃŠNCIAS FINALIZADAS
      </h2>
 <button onclick="window.location.href='/gestao_ocorrencia'"
                    class="mt-4 px-4 py-2 text-sm font-medium rounded-lg text-gray-300 border border-gray-600 hover:bg-gray-700 transition duration-150 flex items-center mx-auto">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                Voltar ao Menu de OcorrÃªncias
            </button>
      <div class="mt-4 flex flex-wrap justify-center gap-4">
      </header>

    <!-- ðŸ”¹ Filtros -->
    <div class="flex flex-wrap justify-center gap-4 mb-6">
      <div>
        <label for="filtro-sala" class="block text-sm font-medium text-gray-300 mb-1">Sala</label>
        <select id="filtro-sala" onchange="filtrarPorSala()"
          class="bg-dark-secondary border border-gray-600 text-gray-200 rounded-lg px-3 py-2">
          <option value="">Todas as Salas</option>
        </select>
      </div>

      <div>
        <label for="filtro-aluno" class="block text-sm font-medium text-gray-300 mb-1">Aluno</label>
        <select id="filtro-aluno" onchange="filtrarPorAluno()"
          class="bg-dark-secondary border border-gray-600 text-gray-200 rounded-lg px-3 py-2">
          <option value="">Todos os Alunos</option>
        </select>
      </div>
    </div>

    <!-- ðŸ”¹ Tabela -->
    <main class="overflow-x-auto bg-dark-secondary rounded-xl shadow-2xl p-4">
      <table class="min-w-full divide-y divide-gray-700">
        <thead class="bg-dark-primary">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">NÃºmero</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Data Reg.</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Aluno</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Sala</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Tutor</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">AÃ§Ãµes</th>
          </tr>
        </thead>
        <tbody id="ocorrencias-corpo" class="divide-y divide-gray-800">
          <tr><td colspan="6" class="text-center py-4 text-gray-400">Carregando...</td></tr>
        </tbody>
      </table>
    </main>
    <footer class="w-full text-center mt-10 p-4 text-gray-400 text-sm border-t border-gray-800">
            <p class="mb-1 text-base font-medium">
                DESENVOLVEDOR: MARCELO ANDRÃ‰ NOGUEIRA CARDES
            </p>
            <p class="text-xs font-light tracking-wide">
                LICENCIADO COMO TESTE PARA E.E. PEI PROFESSORA IRENE DIAS RIBEIRO
            </p>
        </footer>
  </div>
</body>
</html>



