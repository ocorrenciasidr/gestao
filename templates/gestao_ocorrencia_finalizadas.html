<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ocorrências Finalizadas</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = { theme: { extend: { colors: { 'dark-primary':'#0F172A','dark-secondary':'#1E293B','accent':'#10B981','text-light':'#F8FAFC','tutor-color':'#007ACC','coord-color':'#F59E0B','gestao-color':'#EF4444' }}}};

  document.addEventListener('DOMContentLoaded', () => {
    carregarFiltros();
    carregarOcorrencias();
    document.getElementById('filtro-sala').addEventListener('change', carregarOcorrencias);
    document.getElementById('filtro-aluno').addEventListener('change', carregarOcorrencias);
    document.getElementById('btn-limpar-filtros').addEventListener('click', () => {
      document.getElementById('filtro-sala').value = '';
      document.getElementById('filtro-aluno').value = '';
      carregarOcorrencias();
    });
  });

  function mostrarMensagem(texto, tipo = 'info') {
    const el = document.getElementById('mensagem-status');
    el.textContent = texto;
    el.className = 'fixed top-4 right-4 p-3 rounded z-50 text-text-light';
    if (tipo === 'success') el.style.background = '#10B981';
    else if (tipo === 'danger') el.style.background = '#DC2626';
    else el.style.background = '#1E293B';
    setTimeout(()=> el.textContent = '', 3000);
  }

  // Preenche os selects Sala e Aluno (APIs simples: /api/salas, /api/alunos?sala=)
  async function carregarFiltros() {
    try {
      const [rS, rA] = await Promise.all([fetch('/api/salas'), fetch('/api/alunos')]);
      const salas = rS.ok ? await rS.json() : [];
      const alunos = rA.ok ? await rA.json() : [];

      const selSala = document.getElementById('filtro-sala');
      selSala.innerHTML = '<option value="">-- Todas as salas --</option>';
      salas.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id ?? s.sala ?? s.sala_id ?? s.sala_nome;
        opt.text = s.sala ?? s.sala_nome ?? String(s.id);
        selSala.appendChild(opt);
      });

      const selAluno = document.getElementById('filtro-aluno');
      selAluno.innerHTML = '<option value="">-- Todos os alunos --</option>';
      alunos.forEach(a => {
        const opt = document.createElement('option');
        opt.value = a.id ?? a.aluno_id ?? a.aluno_num ?? a.aluno_nome;
        opt.text = a.aluno_nome ?? a.nome ?? String(opt.value);
        selAluno.appendChild(opt);
      });

    } catch (e) {
      console.error('Erro filtros:', e);
      mostrarMensagem('Falha ao carregar filtros', 'danger');
    }
  }

  // Renderiza T/C/G seguindo a regra: aparece se solicitado_* == true AND atendimento_* vazio
  function renderizarAcoes(occ) {
    const numero = occ.numero;
    let html = `<div class="flex items-center space-x-2">
      <a href="/gestao_ocorrencia_editar?id=${numero}&modo=visualizar" title="Visualizar" class="text-gray-400 hover:text-accent">
        <!-- lupa -->
        <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
      </a>`;

    // conversões seguras
    const st = occ.solicitado_tutor === true || occ.solicitado_tutor === 'true' || occ.solicitado_tutor === 1;
    const sc = occ.solicitado_coordenacao === true || occ.solicitado_coordenacao === 'true' || occ.solicitado_coordenacao === 1;
    const sg = occ.solicitado_gestao === true || occ.solicitado_gestao === 'true' || occ.solicitado_gestao === 1;

    const at = (occ.atendimento_tutor || '').toString().trim();
    const ac = (occ.atendimento_coordenacao || '').toString().trim();
    const ag = (occ.atendimento_gestao || '').toString().trim();

    if (st && at === '') html += `<a href="/gestao_ocorrencia_editar?id=${numero}&modo=atendimento&nivel=tutor" class="text-xs font-bold px-2 py-0.5 rounded-full border border-tutor-color bg-tutor-color/10 text-tutor-color">T</a>`;
    if (sc && ac === '') html += `<a href="/gestao_ocorrencia_editar?id=${numero}&modo=atendimento&nivel=coordenacao" class="text-xs font-bold px-2 py-0.5 rounded-full border border-coord-color bg-coord-color/10 text-coord-color">C</a>`;
    if (sg && ag === '') html += `<a href="/gestao_ocorrencia_editar?id=${numero}&modo=atendimento&nivel=gestao" class="text-xs font-bold px-2 py-0.5 rounded-full border border-gestao-color bg-gestao-color/10 text-gestao-color">G</a>`;

    html += '</div>';
    return html;
  }

  // Carregar tabela finalizadas com filtros opcionais
  async function carregarOcorrencias() {
    mostrarMensagem('Carregando...', 'info');
    const tabela = document.getElementById('ocorrencias-corpo');
    tabela.innerHTML = '<tr><td colspan="6" class="py-6 text-center text-gray-400">Carregando...</td></tr>';

    const sala = encodeURIComponent(document.getElementById('filtro-sala').value || '');
    const aluno = encodeURIComponent(document.getElementById('filtro-aluno').value || '');
    let url = '/api/ocorrencias_finalizadas';
    const params = [];
    if (sala) params.push(`sala=${sala}`);
    if (aluno) params.push(`aluno=${aluno}`);
    if (params.length) url += '?' + params.join('&');

    try {
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('Falha ao buscar finalizadas');
      const data = await resp.json();
      if (!Array.isArray(data) || data.length === 0) {
        tabela.innerHTML = '<tr><td colspan="6" class="py-6 text-center text-gray-400">Nenhuma ocorrência finalizada.</td></tr>';
        return;
      }
      let html = '';
      data.forEach(occ => {
        html += `<tr class="hover:bg-dark-secondary/50">
          <td class="p-3 text-sm font-medium text-text-light">${occ.numero}</td>
          <td class="p-3 text-sm text-gray-300">${occ.aluno_nome || ''}</td>
          <td class="p-3 text-sm text-gray-300">${occ.sala_nome || ''}</td>
          <td class="p-3 text-sm text-gray-300">${occ.tutor_nome || ''}</td>
          <td class="p-3 text-sm text-gray-300">${occ.status || ''}</td>
          <td class="p-3 text-sm whitespace-nowrap">${renderizarAcoes(occ)}</td>
        </tr>`;
      });
      tabela.innerHTML = html;
      mostrarMensagem('Finalizadas carregadas', 'success');
    } catch (e) {
      console.error(e);
      tabela.innerHTML = '<tr><td colspan="6" class="py-6 text-center text-red-400">Erro ao carregar.</td></tr>';
      mostrarMensagem('Erro ao carregar finalizadas', 'danger');
    }
  }
</script>
</head>

<body class="bg-dark-primary min-h-screen p-6 text-text-light">
  <div id="mensagem-status" class="hidden fixed top-4 right-4 p-3 rounded z-50 text-text-light"></div>

  <div class="max-w-7xl mx-auto">
    <header class="mb-6">
      <h1 class="text-3xl font-bold text-accent">SISTEMA DE GESTÃO DE CONVIVÊNCIA ESCOLAR</h1>
      <div class="mt-3 flex gap-3">
        <button onclick="window.location.href='/gestao_ocorrencia'" class="px-4 py-2 bg-gray-600 rounded">Voltar</button>
        <button onclick="window.location.href='/gestao_ocorrencia_abertas'" class="px-4 py-2 bg-emerald-700 rounded">Abertas</button>
        <button onclick="window.location.href='/gestao_ocorrencia_nova'" class="px-4 py-2 bg-accent rounded">Nova Ocorrência</button>

        <div class="ml-auto flex gap-2">
          <select id="filtro-sala" class="px-2 py-1 rounded bg-dark-secondary"></select>
          <select id="filtro-aluno" class="px-2 py-1 rounded bg-dark-secondary"></select>
          <button id="btn-limpar-filtros" class="px-3 py-1 rounded bg-gray-700">Limpar</button>
        </div>
      </div>
    </header>

    <main class="bg-dark-secondary p-4 rounded">
      <table class="w-full">
        <thead class="text-xs text-gray-400">
          <tr>
            <th class="text-left p-2">Número</th>
            <th class="text-left p-2">Aluno</th>
            <th class="text-left p-2">Sala</th>
            <th class="text-left p-2">Tutor</th>
            <th class="text-left p-2">Status</th>
            <th class="text-left p-2">Ações</th>
          </tr>
        </thead>
        <tbody id="ocorrencias-corpo" class="divide-y">
          <tr><td colspan="6" class="py-6 text-center text-gray-400">Carregando dados...</td></tr>
        </tbody>
      </table>
    </main>
  </div>
</body>
</html>
