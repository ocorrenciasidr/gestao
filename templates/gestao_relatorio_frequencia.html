<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Relatório Mensal de Frequência</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .cell-P{background:#10B981;color:white;font-weight:700;border-radius:6px;padding:6px;text-align:center;}
  .cell-F{background:#DC2626;color:white;font-weight:700;border-radius:6px;padding:6px;text-align:center;}
  .cell-PA{background:#F59E0B;color:#111;font-weight:700;border-radius:6px;padding:6px;text-align:center;}
  .cell-empty{background:#374151;color:#9CA3AF;border-radius:6px;padding:6px;text-align:center;}
  .modal-bg{background:rgba(0,0,0,0.6);}
</style>
</head>
<body class="bg-dark-primary text-text-light font-sans">
<div class="max-w-6xl mx-auto p-6">

  <!-- HEADER -->
  <header class="text-center mb-6">
    <h1 class="text-2xl text-text-light mt-2 font-light border-b border-gray-700 pb-2 inline-block">
      SISTEMA DE GESTÃO DE CONVIVÊNCIA ESCOLAR
    </h1><br>
    <h2 class="text-lg text-text-light mt-2 font-light border-b border-gray-700 pb-2 inline-block">
      RELATÓRIO DE FREQUÊNCIA MENSAL
    </h2>
    <div class="mt-4">
      <button onclick="window.location.href='/gestao_ocorrencia'"
              class="mt-4 px-4 py-2 text-sm font-medium rounded-lg text-gray-300 border border-gray-600 hover:bg-gray-700 transition duration-150">
        ← Voltar ao Menu de Ocorrências
      </button>
    </div>
  </header>

  <!-- FILTROS -->
  <div class="bg-dark-secondary p-6 rounded-lg mb-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm text-gray-300 mb-1">Sala:</label>
        <select id="filter-sala" class="w-full p-3 rounded bg-white text-black"></select>
      </div>
      <div>
        <label class="block text-sm text-gray-300 mb-1">Mês:</label>
        <input id="filter-mes" type="month" class="w-full p-3 rounded bg-white text-black"/>
      </div>
      <div class="flex items-end">
        <button id="btn-gerar" class="w-full bg-info text-white font-bold py-3 px-4 rounded hover:brightness-110">Gerar Relatório</button>
      </div>
    </div>
  </div>

  <!-- RESULTADO -->
  <div id="report-container" class="hidden bg-dark-secondary p-4 rounded-lg mb-6">
    <div class="flex justify-between items-center mb-3">
      <div>
        <h3 id="report-title" class="text-lg font-bold text-info">Relatório</h3>
        <p id="report-sub" class="text-sm text-gray-300"></p>
      </div>
      <div class="flex gap-3">
        <button id="btn-download-pdf" class="bg-accent text-white font-bold py-2 px-3 rounded hidden">Gerar PDF</button>
        <button id="btn-export-csv" class="bg-gray-700 text-white font-bold py-2 px-3 rounded">Exportar CSV</button>
      </div>
    </div>

    <div id="table-wrap" class="overflow-auto">
      <!-- tabela será inserida aqui -->
    </div>
    <p class="mt-3 text-xs text-gray-400">Legenda: <span class="cell-P px-2">P</span> Presença &nbsp; <span class="cell-F px-2">F</span> Falta &nbsp; <span class="cell-PA px-2">PA/PS/PAS</span> Atraso/Saída</p>
  </div>

  <!-- MODAL -->
  <div id="modal" class="hidden fixed inset-0 z-50 items-center justify-center">
    <div class="modal-bg absolute inset-0"></div>
    <div class="bg-dark-secondary max-w-lg w-full p-6 rounded-lg z-60 relative">
      <h4 class="text-xl font-bold mb-2">Detalhes</h4>
      <p id="modal-text" class="text-gray-200 mb-4"></p>
      <div class="flex justify-end gap-3">
        <button onclick="closeModal()" class="px-4 py-2 bg-gray-600 rounded text-white">Fechar</button>
      </div>
    </div>
  </div>

</div>

<script>
  // feriados fixos (aplicados ao ano selecionado)
  function monthHolidays(year) {
    return [
      `${year}-10-27`,
      `${year}-11-20`
    ];
  }

  // carrega salas no select
  async function loadSalas() {
    try {
      const r = await fetch('/api/salas');
      const salas = await r.json();
      const sel = document.getElementById('filter-sala');
      sel.innerHTML = '<option value="">-- Selecione --</option>';
      salas.forEach(s => sel.innerHTML += `<option value="${s.id}">${s.nome}</option>`);
    } catch (e) {
      alert('Erro ao carregar salas');
    }
  }
  loadSalas();

  document.getElementById('btn-gerar').addEventListener('click', gerarRelatorio);

  // gera lista de dias úteis do mês, excluindo finais de semana e feriados listados
  function getBusinessDaysOfMonth(year, month, extraHolidays=[]) {
    const days = [];
    // month: 1..12
    const first = new Date(year, month-1, 1);
    const last = new Date(year, month, 0); // último dia
    for(let d = new Date(first); d <= last; d.setDate(d.getDate()+1)){
      const dow = d.getDay(); // 0 sun .. 6 sat
      const iso = d.toISOString().slice(0,10);
      if (dow===0 || dow===6) continue; // pula sáb e dom
      if (extraHolidays.includes(iso)) continue; // pula feriado
      days.push(iso);
    }
    return days;
  }

  // solicita dados ao backend e monta tabela
  async function gerarRelatorio(){
    const salaId = document.getElementById('filter-sala').value;
    const mesVal = document.getElementById('filter-mes').value; // YYYY-MM
    if (!salaId || !mesVal) { alert('Selecione sala e mês'); return; }

    const [yy, mm] = mesVal.split('-');
    const year = parseInt(yy), month = parseInt(mm);
    const holidays = monthHolidays(year); // aplica feriados

    const dias = getBusinessDaysOfMonth(year, month, holidays);

    // chama API para obter os dados (espera formato: {alunos: [{id,nome}], frequencias: [{aluno_id, data, status, motivo_atraso, motivo_saida}]})
    const url = `/api/relatorio_frequencia_mensal?sala_id=${salaId}&year=${year}&month=${month}`;
    const resp = await fetch(url);
    if (!resp.ok) { alert('Erro ao gerar relatório'); return; }
    const payload = await resp.json();

    // monta mapa de frequências por aluno x data
    const freqMap = {}; // freqMap[aluno_id] = {date: record, ...}
    (payload.frequencias || []).forEach(rec => {
      freqMap[rec.aluno_id] = freqMap[rec.aluno_id] || {};
      freqMap[rec.aluno_id][rec.data] = rec;
    });

    // tabela: header com dias curtos (dd / Ddd)
    let html = '<table class="min-w-full text-sm border-collapse"><thead><tr><th class="p-2 text-left">Aluno</th>';
    dias.forEach(d => {
      const dt = new Date(d);
      const dayNum = dt.getDate();
      const dayName = dt.toLocaleDateString('pt-BR', { weekday: 'short' });
      html += `<th class="p-2 text-center">${dayNum}<br><span class="text-xs text-gray-400">${dayName}</span></th>`;
    });
    html += '</tr></thead><tbody>';

    (payload.alunos || []).forEach(aluno => {
      html += `<tr class="border-t border-gray-700"><td class="p-2">${aluno.nome}</td>`;
      dias.forEach(d => {
        const rec = (freqMap[aluno.id]||{})[d];
        if (!rec) { html += `<td class="p-2"><div class="cell-empty">-</div></td>`; }
        else {
          const s = rec.status;
          if (s === 'P') html += `<td class="p-2"><div class="cell-P">P</div></td>`;
          else if (s === 'F') html += `<td class="p-2"><div class="cell-F">F</div></td>`;
          else { // PA / PS / PAS (amarelo) — clicável para modal
            const motivo = (rec.motivo_atraso || rec.motivo_saida || 'Sem motivo registrado').replaceAll('"','\'');
            html += `<td class="p-2"><div class="cell-PA" style="cursor:pointer" onclick="openModal('${aluno.nome}','${d}','${s}','${motivo}')">${s}</div></td>`;
          }
        }
      });
      html += '</tr>';
    });

    html += '</tbody></table>';

    document.getElementById('table-wrap').innerHTML = html;
    document.getElementById('report-container').classList.remove('hidden');
    document.getElementById('report-title').textContent = `Relatório ${mesVal}`;
    document.getElementById('report-sub').textContent = `Sala: ${payload.sala_nome || salaId} • Dias úteis: ${dias.length}`;
    document.getElementById('btn-download-pdf').classList.remove('hidden');

    // botão PDF: envia os mesmos dados ao backend para gerar o PDF idêntico
    document.getElementById('btn-download-pdf').onclick = async function(){
      try {
        const pdfResp = await fetch('/api/gerar_pdf_frequencia', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ sala_id: salaId, year, month })
        });
        if (!pdfResp.ok) { alert('Erro ao gerar PDF'); return; }
        const blob = await pdfResp.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `relatorio_frequencia_${salaId}_${year}-${String(month).padStart(2,'0')}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      } catch(e) { alert('Erro ao gerar/baixar PDF'); console.error(e); }
    };

    // Export CSV (simples)
    document.getElementById('btn-export-csv').onclick = function(){
      const rows = [];
      const headers = ['Aluno', ...dias];
      rows.push(headers.join(','));
      (payload.alunos||[]).forEach(aluno => {
        const cols = [ `"${aluno.nome.replaceAll('"','""')}"` ];
        dias.forEach(d => {
          const rec = (freqMap[aluno.id]||{})[d];
          cols.push(rec ? rec.status : '');
        });
        rows.push(cols.join(','));
      });
      const csv = rows.join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url;
      a.download = `relatorio_frequencia_${year}-${String(month).padStart(2,'0')}.csv`;
      a.click();
    };
  }

  // modal functions
  function openModal(aluno, data, status, motivo){
    const txt = `<strong>${aluno}</strong><br>Data: ${data}<br>Status: ${status}<br><br><strong>Motivo:</strong><br>${motivo}`;
    document.getElementById('modal-text').innerHTML = txt;
    const modal = document.getElementById('modal'); modal.classList.remove('hidden'); modal.classList.add('flex');
  }
  function closeModal(){ const m = document.getElementById('modal'); m.classList.add('hidden'); m.classList.remove('flex'); }
</script>
</body>
</html>
