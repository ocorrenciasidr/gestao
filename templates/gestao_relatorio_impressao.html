<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Impressão de Ocorrências</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        'dark-primary': '#0F172A',
        'dark-secondary': '#1E293B',
        'accent': '#10B981',
        'text-light': '#F8FAFC',
        'danger': '#DC2626',
        'secondary-accent': '#3B82F6'
      },
    },
  },
};

let salas = [];
let alunos = [];
let ocorrencias = [];
let nomeAlunoAtual = "";

document.addEventListener('DOMContentLoaded', async () => {
  await carregarSalas();
  document.getElementById('filter-sala').addEventListener('change', carregarAlunos);
});

async function carregarSalas() {
  const sel = document.getElementById('filter-sala');
  sel.innerHTML = '<option>Carregando...</option>';
  const resp = await fetch('/api/salas_com_ocorrencias');
  salas = await resp.json();
  sel.innerHTML = '<option value="">Selecione a Sala</option>';
  salas.forEach(s => sel.innerHTML += `<option value="${s.id}">${s.nome}</option>`);
}

async function carregarAlunos() {
  const sala = document.getElementById('filter-sala').value;
  const sel = document.getElementById('filter-aluno');
  sel.innerHTML = '<option>Carregando...</option>';
  // Usa o endpoint correto
  const resp = await fetch(`/api/alunos_com_ocorrencias_por_sala/${sala}`);
  alunos = await resp.json();
  sel.innerHTML = '<option value="">Selecione o Aluno</option>';
  alunos.forEach(a => sel.innerHTML += `<option value="${a.id}">${a.nome}</option>`);
}

async function buscarOcorrencias() {
  const aluno = document.getElementById('filter-aluno').value;
  if (!aluno) {
    alert('Selecione o aluno');
    return;
  }
  const resp = await fetch(`/api/ocorrencias_por_aluno/${aluno}`);
  ocorrencias = await resp.json();
  nomeAlunoAtual = ocorrencias[0]?.aluno_nome || "";
  renderizarOcorrencias();
}

function renderizarOcorrencias() {
  const div = document.getElementById('ocorrencias-lista');
  if (!ocorrencias.length) {
    div.innerHTML = '<p class="text-gray-400 text-center">Nenhuma ocorrência encontrada.</p>';
    return;
  }
  div.innerHTML = ocorrencias.map(o => `
    <div class="flex items-start gap-3 border-b border-gray-700 py-3">
      <input type="checkbox" value="${o.numero}" class="mt-1 h-4 w-4 accent-accent">
      <div>
        <p><strong>Número:</strong> ${o.numero}</p>
        <p><strong>Data:</strong> ${new Date(o.data_hora).toLocaleString('pt-BR')}</p>
        <p><strong>Descrição:</strong> ${o.descricao}</p>
        <p><strong>Status:</strong> ${o.status}</p>
      </div>
    </div>
  `).join('');
}

async function gerarPDF() {
  const selecionadas = [...document.querySelectorAll('#ocorrencias-lista input:checked')].map(c => c.value);
  if (!selecionadas.length) {
    alert('Selecione pelo menos uma ocorrência');
    return;
  }
  const resp = await fetch('/api/gerar_pdf_ocorrencias', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ numeros: selecionadas })
  });
  const blob = await resp.blob();
  const url = URL.createObjectURL(blob);

  // Download com nome do aluno completo
  const nomeArquivo = (nomeAlunoAtual ? nomeAlunoAtual.replace(/\s/g,'_') : 'relatorio') + '_ocorrencias.pdf';
  const a = document.createElement('a');
  a.href = url;
  a.download = nomeArquivo;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);

  // Desabilita as caixas selecionadas
  document.querySelectorAll('#ocorrencias-lista input:checked').forEach(chk => chk.disabled = true);
}
</script>
</head>

<body class="bg-dark-primary text-text-light min-h-screen p-6">
  <!-- CABEÇALHO PADRONIZADO -->
  <header class="w-full text-center mb-8 mt-4">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-secondary-accent leading-tight tracking-wider">
      SISTEMA DE GESTÃO DE CONVIVÊNCIA ESCOLAR
    </h1>
    <h2 class="text-xl sm:text-2xl text-text-light mt-2 font-light border-b border-gray-700 pb-2 inline-block">
      GESTÃO DE RELATÓRIOS - IMPRESSÃO DE OCORRÊNCIAS
    </h2>

    <button onclick="window.location.href='/gestao_relatorio'" 
      class="mt-4 px-4 py-2 text-sm font-medium rounded-lg text-gray-300 border border-gray-600 hover:bg-gray-700 transition duration-150 flex items-center mx-auto">
      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path>
      </svg>
      Voltar ao Menu de Relatórios
    </button>
  </header>

  <!-- CONTEÚDO PRINCIPAL -->
  <main class="max-w-4xl mx-auto space-y-6">
    <section class="bg-dark-secondary p-6 rounded-lg shadow-lg">
      <h3 class="text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-accent">Filtros</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="filter-sala" class="block mb-1 text-sm text-gray-300">Sala:</label>
          <select id="filter-sala" class="w-full p-2 rounded text-black"></select>
        </div>
        <div>
          <label for="filter-aluno" class="block mb-1 text-sm text-gray-300">Aluno:</label>
          <select id="filter-aluno" class="w-full p-2 rounded text-black"></select>
        </div>
      </div>
      <button onclick="buscarOcorrencias()" 
        class="mt-4 bg-danger px-4 py-2 rounded text-white font-semibold hover:bg-red-700 w-full">
        Buscar Ocorrências
      </button>
    </section>

    <section class="bg-dark-secondary p-6 rounded-lg shadow-lg">
      <h3 class="text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-accent">Ocorrências Encontradas</h3>
      <div id="ocorrencias-lista" class="space-y-2"></div>
      <button onclick="gerarPDF()" 
        class="mt-6 bg-accent px-4 py-3 rounded-lg text-white font-bold w-full hover:bg-emerald-700">
        Gerar PDF
      </button>
    </section>
  </main>

  <!-- RODAPÉ PADRONIZADO -->
  <footer class="w-full text-center mt-10 p-4 text-gray-400 text-sm border-t border-gray-800">
    <p class="mb-1 text-base font-medium">
      DESENVOLVEDOR: MARCELO ANDRÉ NOGUEIRA CARDES
    </p>
    <p class="text-xs font-light tracking-wide">
      LICENCIADO COMO TESTE PARA E.E. PEI PROFESSORA IRENE DIAS RIBEIRO
    </p>
  </footer>
</body>
</html>
