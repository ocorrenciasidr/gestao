<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Frequência</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-primary': '#0F172A', 'dark-secondary': '#1E293B',
                        'secondary-accent': '#4F46E5', 'accent-success': '#10B981',
                        'alert-danger': '#DC2626', 'text-light': '#F8FAFC',
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                }
            }
        }
    </script>
    <style>
        body { background-color: #0F172A; color: #F8FAFC; font-family: sans-serif; }
        .form-select, .form-input {
            @apply w-full p-3 bg-white border border-gray-700 rounded-lg text-black focus:ring-secondary-accent focus:border-secondary-accent;
            appearance: menulist !important;
            color: black !important;
        }
        .form-radio { @apply w-4 h-4 text-secondary-accent bg-gray-100 border-gray-300; }
        .status-P { background-color: #10B981; } /* Verde - Presença */
        .status-F { background-color: #DC2626; } /* Vermelho - Falta */
        /* Cores para os botões de status */
        .status-btn-P { @apply bg-accent-success hover:bg-green-600; }
        .status-btn-F { @apply bg-alert-danger hover:bg-red-600; }
        /* Cores para os dias já registrados */
        .registered-row input[type="radio"] { cursor: not-allowed; }
        .registered-row label { cursor: not-allowed; opacity: 0.7; }
        .registered-row button { cursor: not-allowed; opacity: 0.5; }

    </style>
    <script>
        let salasData = [];
        let alunosData = [];
        let frequenciaData = {}; // Para armazenar P/F da chamada inicial
        let isEditing = false; // Flag para o modo de edição

        document.addEventListener('DOMContentLoaded', () => {
            loadSalas();
            document.getElementById('select-sala').addEventListener('change', checkFrequencyStatus);
            document.getElementById('input-data').addEventListener('change', checkFrequencyStatus);
            document.getElementById('btn-editar-frequencia').addEventListener('click', toggleEditMode);
            document.getElementById('btn-salvar-frequencia').addEventListener('click', saveFrequency);
        });

        async function loadSalas() {
            try {
                const response = await fetch('/api/salas');
                salasData = await response.json();
                const selectSala = document.getElementById('select-sala');
                selectSala.innerHTML = '<option value="">Selecione a Sala</option>';
                salasData.forEach(sala => {
                    selectSala.innerHTML += `<option value="${sala.id}">${sala.nome}</option>`;
                });
            } catch (error) {
                console.error('Erro ao carregar salas:', error);
                mostrarMsg('Erro ao carregar salas.', 'alert-danger');
            }
        }

        async function loadAlunos(sala_id) {
            try {
                const response = await fetch(`/api/alunos_por_sala/${sala_id}`);
                alunosData = await response.json();
                renderAlunosList();
            } catch (error) {
                console.error('Erro ao carregar alunos:', error);
                mostrarMsg('Erro ao carregar alunos desta sala.', 'alert-danger');
            }
        }

        async function checkFrequencyStatus() {
            const salaId = document.getElementById('select-sala').value;
            const data = document.getElementById('input-data').value;
            const alunosContainer = document.getElementById('alunos-list-container');
            const statusDiv = document.getElementById('registro-status');

            alunosContainer.classList.add('hidden');
            statusDiv.innerHTML = '';
            document.getElementById('btn-salvar-frequencia').classList.add('hidden');
            document.getElementById('btn-editar-frequencia').classList.add('hidden');
            frequenciaData = {};
            isEditing = false;

            if (!salaId || !data) return;

            try {
                // 1. Verificar se a frequência já foi registrada
                const statusResponse = await fetch(`/api/frequencia/status?sala_id=${salaId}&data=${data}`);
                const statusData = await statusResponse.json();

                if (statusData.registrada) {
                    statusDiv.innerHTML = `<span class="text-accent-success font-bold">Frequência já registrada para esta sala e data.</span>`;
                    document.getElementById('btn-editar-frequencia').classList.remove('hidden');
                    alunosContainer.classList.remove('hidden');
                    document.getElementById('btn-salvar-frequencia').classList.add('hidden');
                    
                    // 2. Carregar dados existentes para exibição/edição
                    await loadExistingFrequency(salaId, data);
                    renderAlunosList(true); // Renderiza bloqueado

                } else {
                    statusDiv.innerHTML = `<span class="text-secondary-accent font-bold">Frequência Pendente.</span>`;
                    document.getElementById('btn-salvar-frequencia').classList.remove('hidden');
                    alunosContainer.classList.remove('hidden');
                    loadAlunos(salaId); // Carrega a lista vazia para registro
                }
            } catch (error) {
                console.error('Erro ao verificar status:', error);
                mostrarMsg('Erro ao verificar status da frequência.', 'alert-danger');
            }
        }
        
        async function loadExistingFrequency(sala_id, data) {
            try {
                const url = `/api/relatorio_frequencia_detalhada?sala_id=${sala_id}&mes_ano=${data.substring(0, 7)}`;
                const response = await fetch(url);
                const dataRaw = await response.json();
                
                if (dataRaw.error) throw new Error(dataRaw.error);

                // Filtrar a frequência apenas para a data selecionada
                frequenciaData = {};
                if (dataRaw.relatorio) {
                    dataRaw.relatorio.forEach(alunoRow => {
                        const registroDia = alunoRow.dias.find(d => d.data === data);
                        if (registroDia && registroDia.status !== '?') {
                            frequenciaData[alunoRow.id] = registroDia.status;
                        }
                    });
                }
                loadAlunos(sala_id); // Recarrega alunos para usar o frequenciaData
            } catch (error) {
                console.error('Erro ao carregar frequência existente:', error);
                mostrarMsg('Erro ao carregar dados existentes para edição.', 'alert-danger');
            }
        }

        function renderAlunosList(lock = false) {
            const tbody = document.getElementById('alunos-list-body');
            tbody.innerHTML = '';
            const isLocked = lock && !isEditing;
            
            alunosData.forEach(aluno => {
                const currentStatus = frequenciaData[aluno.id] || 'F'; // Default para Falta se não existir ou se for o primeiro registro
                let statusF = currentStatus === 'F';
                let statusP = currentStatus.includes('P') && currentStatus.length === 1;
                
                // Se for PA, PS ou PAS, exibe como Presença (P), mas impede alteração
                if (currentStatus.includes('A') || currentStatus.includes('S')) {
                    statusP = true;
                    statusF = false;
                }

                let statusPA = currentStatus === 'PA';
                let statusPS = currentStatus === 'PS';
                let statusPAS = currentStatus === 'PAS';
                
                const rowClasses = isLocked ? 'registered-row' : '';
                const disabledAttr = isLocked ? 'disabled' : '';

                const row = document.createElement('tr');
                row.className = `border-b border-gray-700 hover:bg-dark-primary transition ${rowClasses}`;
                
                row.innerHTML = `
                    <td class="p-3 text-left">${aluno.nome}</td>
                    <td class="p-3 text-center">
                        <div class="flex items-center justify-center space-x-4">
                            <!-- Presença (P) -->
                            <label class="inline-flex items-center text-accent-success">
                                <input type="radio" name="status-${aluno.id}" value="P" class="form-radio" ${statusP || statusPA || statusPS || statusPAS ? 'checked' : ''} ${disabledAttr}>
                                <span class="ml-2">P</span>
                            </label>
                            
                            <!-- Falta (F) -->
                            <label class="inline-flex items-center text-alert-danger">
                                <input type="radio" name="status-${aluno.id}" value="F" class="form-radio" ${statusF ? 'checked' : ''} ${disabledAttr}>
                                <span class="ml-2">F</span>
                            </label>
                            
                            <!-- Botão de Detalhes (só aparece se já tiver PA, PS, PAS) -->
                            ${(statusPA || statusPS || statusPAS) && isLocked ? `<span class="text-sm font-semibold text-secondary-accent ml-4">${currentStatus}</span>` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            document.getElementById('list-title').textContent = isEditing ? 'Lista de Alunos (Modo Edição)' : 'Lista de Alunos';
            
            // Re-esconde o botão de salvar no modo visualizar/bloqueado
            if (isLocked) {
                document.getElementById('btn-salvar-frequencia').classList.add('hidden');
            } else {
                document.getElementById('btn-salvar-frequencia').classList.remove('hidden');
            }
        }
        
        function toggleEditMode() {
            isEditing = !isEditing;
            const btn = document.getElementById('btn-editar-frequencia');
            
            if (isEditing) {
                btn.textContent = 'Cancelar Edição';
                btn.classList.replace('bg-secondary-accent', 'bg-alert-danger');
            } else {
                btn.textContent = 'Editar Frequência';
                btn.classList.replace('bg-alert-danger', 'bg-secondary-accent');
            }
            renderAlunosList(true); // Chama renderização no novo modo
        }


        async function saveFrequency() {
            const salaId = document.getElementById('select-sala').value;
            const data = document.getElementById('input-data').value;
            
            if (!salaId || !data) {
                mostrarMsg('Selecione Sala e Data.', 'alert-danger');
                return;
            }

            const registrations = [];
            
            alunosData.forEach(aluno => {
                const radioValue = document.querySelector(`input[name="status-${aluno.id}"]:checked`);
                if (radioValue) {
                    const status = radioValue.value;
                    // Se o status for P ou F E não for um registro de PA/PS/PAS que queremos preservar
                    if (status === 'P' || status === 'F') {
                        const existingStatus = frequenciaData[aluno.id];
                        // Só permite salvar P/F se não for sobrescrever PA/PS/PAS
                        if (existingStatus === 'PA' || existingStatus === 'PS' || existingStatus === 'PAS') {
                             // Se estiver editando e mudar PA/PS/PAS para P ou F, forçamos a P ou F
                             // Mas se não estiver editando, não faz nada (o radio está desabilitado)
                             if (isEditing) {
                                registrations.push({
                                    aluno_id: aluno.id,
                                    sala_id: salaId,
                                    data: data,
                                    status: status // Sobrescreve
                                });
                             }
                        } else {
                            registrations.push({
                                aluno_id: aluno.id,
                                sala_id: salaId,
                                data: data,
                                status: status
                            });
                        }
                    }
                }
            });

            if (registrations.length === 0) {
                mostrarMsg('Nenhuma alteração de Presença/Falta (P/F) válida detectada.', 'alert-danger');
                return;
            }
            
            mostrarMsg('Salvando frequência...', 'secondary-accent');
            
            try {
                const response = await fetch('/api/salvar_frequencia', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(registrations)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Erro desconhecido ao salvar.');
                }

                mostrarMsg(result.message, 'accent-success');
                // Bloqueia após salvar e recarrega para mostrar o estado atual
                toggleEditMode();
                checkFrequencyStatus();

            } catch (error) {
                console.error('Erro ao salvar frequência:', error);
                mostrarMsg(`Erro ao salvar: ${error.message}`, 'alert-danger');
            }
        }

        function mostrarMsg(msg, tipo = 'info') {
            const el = document.getElementById('global-message');
            el.textContent = msg;
            el.className = `p-3 rounded mt-4 text-white font-bold`;
            el.style.display = 'block';

            if (tipo === 'alert-danger') {
                el.classList.add('bg-alert-danger');
            } else if (tipo === 'accent-success') {
                el.classList.add('bg-accent-success');
            } else {
                el.classList.add('bg-secondary-accent');
            }

            setTimeout(() => el.style.display = 'none', 5000);
        }
    </script>
</head>
<body class="flex flex-col items-center justify-center min-h-screen">
    <div class="w-full max-w-4xl flex-grow p-4">
        <h1 class="text-3xl font-extrabold mb-6 text-center text-accent-success">Registro de Frequência</h1>

        <div id="global-message" style="display: none;"></div>

        <div class="bg-dark-secondary p-8 rounded-xl shadow-2xl space-y-6">
            <h3 class="text-2xl font-bold border-b border-gray-600 pb-3 text-secondary-accent">1. FILTROS</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="select-sala" class="block text-sm font-medium text-gray-300 mb-1">Sala:</label>
                    <select id="select-sala" class="form-select" required></select>
                </div>
                <div>
                    <label for="input-data" class="block text-sm font-medium text-gray-300 mb-1">Data:</label>
                    <input id="input-data" type="date" class="form-select" required>
                </div>
            </div>
            
            <div id="registro-status" class="pt-2 text-center text-lg"></div>

            <div class="flex justify-end gap-3 pt-3">
                <button id="btn-editar-frequencia" type="button" class="px-6 py-2 bg-secondary-accent hover:bg-indigo-600 text-white font-bold rounded-lg hidden">
                    Editar Frequência
                </button>
            </div>
        </div>

        <div id="alunos-list-container" class="bg-dark-secondary p-8 rounded-xl shadow-2xl mt-6 hidden">
            <h3 id="list-title" class="text-2xl font-bold border-b border-gray-600 pb-3 text-secondary-accent">Lista de Alunos</h3>
            <table class="w-full mt-4 border-collapse">
                <thead class="text-left text-sm text-gray-400 border-b border-gray-700">
                    <tr>
                        <th class="p-3">Aluno</th>
                        <th class="p-3 text-center">Status (P/F)</th>
                    </tr>
                </thead>
                <tbody id="alunos-list-body">
                    <!-- Linhas dos alunos serão inseridas aqui -->
                </tbody>
            </table>
            <button id="btn-salvar-frequencia" class="mt-4 bg-accent-success hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg w-full transition duration-200 hidden">
                Salvar Frequência
            </button>
        </div>
    </div>
</body>
</html>
