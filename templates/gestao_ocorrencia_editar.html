<!DOCTYPE html><html lang="pt-BR"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><title>Ocorrência</title><script src="https://cdn.tailwindcss.com"></script><script>tailwind.config = { theme: { extend: { colors: { 'dark-primary':'#0F172A','dark-secondary':'#1E293B','accent':'#10B981','text-light':'#FFFFFF' }}}};let numeroGlobal = null;let camposAtendimento = ['atendimento_tutor', 'atendimento_coordenacao', 'atendimento_gestao'];document.addEventListener('DOMContentLoaded', () => {const params = new URLSearchParams(window.location.search);numeroGlobal = params.get('id') || params.get('numero');const modo = params.get('modo') || 'visualizar';if (!numeroGlobal) {
  mostrarMsg('Número da ocorrência não fornecido.', 'error');
  return;
}
carregarDetalhes(numeroGlobal, modo);

// Mostra o botão de voltar apenas no modo visualizar
if (modo === 'visualizar') {
  document.getElementById('btn-voltar-container').style.display = 'block';
}

document.getElementById('form-atendimento').addEventListener('submit', async (e) => {
  e.preventDefault();
  await salvarAtendimento();
});
});function mostrarMsg(msg, tipo='info') {const el = document.getElementById('mensagem-status');el.textContent = msg;el.className = p-3 rounded mt-4 text-white ${tipo === 'error' ? 'bg-red-500' : 'bg-blue-500'};el.style.display = 'block';setTimeout(() => el.style.display = 'none', 5000);}async function carregarDetalhes(numero) {try {const response = await fetch(/api/ocorrencia_detalhes?numero=${numero});const data = await response.json();  if (data.error) {
    mostrarMsg(`Erro ao carregar: ${data.error}`, 'error');
    return;
  }

  document.getElementById('numero').textContent = data.numero;
  document.getElementById('aluno_nome').textContent = data.aluno_nome;
  document.getElementById('sala_nome').textContent = data.sala_nome;
  document.getElementById('tutor_nome').textContent = data.tutor_nome;
  document.getElementById('professor_nome').textContent = data.professor_nome;
  document.getElementById('status').textContent = data.status;
  document.getElementById('descricao').textContent = data.descricao;
  document.getElementById('atendimento_professor').value = data.atendimento_professor || 'Não Registrado';
  document.getElementById('atendimento_professor').readOnly = true;

  // Preencher e habilitar/desabilitar campos de atendimento
  camposAtendimento.forEach(campo => {
    const el = document.getElementById(campo);
    const nivel = campo.split('_')[1]; // tutor, coordenacao, gestao
    el.value = data[campo] || '';

    // Habilita a edição apenas se o campo estiver vazio
    if (!data[campo] || data[campo].trim() === 'ATENDIMENTO NÃO SOLICITADO PELO RESPONSÁVEL DA OCORRÊNCIA') {
      el.readOnly = false;
      el.placeholder = `Registre o atendimento de ${nivel}...`;
      // Mostrar o botão de salvar se houver algum campo de atendimento habilitado
      document.getElementById('btn-salvar').classList.remove('hidden');
    } else {
      el.readOnly = true;
      el.placeholder = 'Atendimento já registrado';
    }
  });
  
  // Se todos os atendimentos solicitados estiverem preenchidos, o botão deve sumir
  const isFinalizada = data.status === 'Finalizada';
  if (isFinalizada) {
      document.getElementById('btn-salvar').classList.add('hidden');
  }

} catch (error) {
  console.error('Falha na requisição de detalhes:', error);
  mostrarMsg('Erro ao carregar detalhes da ocorrência. Verifique a console.', 'error');
}
}async function salvarAtendimento() {let nivel_salvar = null;let texto_salvar = '';// 1. Determina qual campo foi preenchido e não está 'readOnly'
for (const campo of camposAtendimento) {
    const el = document.getElementById(campo);
    if (!el.readOnly && el.value.trim() !== '') {
        nivel_salvar = campo.split('_')[1]; // Ex: 'tutor'
        texto_salvar = el.value.trim();
        break; // Salva o primeiro que encontrar
    }
}

if (!nivel_salvar) {
    mostrarMsg('Preencha pelo menos um campo de atendimento habilitado para salvar.', 'error');
    return;
}

const payload = {
    nivel: nivel_salvar,
    texto: texto_salvar
};

try {
    mostrarMsg(`Salvando atendimento de ${nivel_salvar}...`, 'info');
    
    const response = await fetch(`/api/registrar_atendimento/${numeroGlobal}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        // ENVIO DO JSON CORRETO
        body: JSON.stringify(payload)
    });

    // Verifica se a resposta foi HTTP 200 OK
    if (!response.ok) {
        // Se a resposta for um erro HTTP (ex: 500), tenta ler o JSON de erro
        const errorData = await response.json().catch(() => ({error: 'Resposta inválida ou erro do servidor (não JSON).'}));
        mostrarMsg(`Erro ao salvar: ${errorData.error || 'Erro desconhecido.'} (Status: ${response.status})`, 'error');
        console.error('Detalhes do erro:', errorData);
        return;
    }

    const result = await response.json();

    if (result.error) {
         mostrarMsg(`Erro ao salvar: ${result.error}`, 'error');
         return;
    }
    
    mostrarMsg(`Atendimento de ${nivel_salvar} salvo com sucesso!`, 'success');
    
    // Recarrega os detalhes para atualizar o estado e desabilitar o campo
    carregarDetalhes(numeroGlobal, 'editar'); 

} catch (error) {
    console.error('Falha na requisição salvarAtendimento:', error);
    // Este catch pegará o erro 'Unexpected token <' se o servidor retornar HTML
    mostrarMsg(`Erro ao salvar: Resposta inválida (HTML inesperado). Verifique o console.`, 'error');
}
}</script><style>body { background-color: #0F172A; color: #F8FAFC; font-family: sans-serif; }.header-info span { display: block; font-size: 0.8rem; color: #94A3B8; }.header-info strong { font-size: 1rem; color: #FFFFFF; }textarea:read-only { background-color: #334155; opacity: 0.8; cursor: not-allowed; }</style></head><body class="p-4 md:p-8"><div class="max-w-4xl mx-auto"><header class="mb-6"><h1 class="text-3xl font-bold text-accent">Detalhes da Ocorrência</h1><div id="mensagem-status" style="display: none;" class="mt-3"></div><div class="mt-4 flex gap-2"><div id="btn-voltar-container" style="display: block;"><button onclick="window.history.back()" class="px-4 py-2 bg-gray-600 rounded text-white">← Voltar</button></div><div class="ml-auto"><span id="status" class="px-3 py-1 rounded text-sm font-semibold"></span></div></div></header><main class="bg-dark-secondary p-6 rounded-lg shadow-lg">
  <div class="grid grid-cols-2 gap-4 mb-6 header-info">
    <div><span>Número:</span><strong id="numero">N/A</strong></div>
    <div><span>Aluno:</span><strong id="aluno_nome">N/A</strong></div>
    <div><span>Sala:</span><strong id="sala_nome">N/A</strong></div>
    <div><span>Tutor:</span><strong id="tutor_nome">N/A</strong></div>
    <div><span>Professor:</span><strong id="professor_nome">N/A</strong></div>
  </div>

  <div class="mb-4">
    <label class="block text-sm font-medium mb-1">Descrição da Ocorrência</label>
    <textarea id="descricao" rows="4" class="w-full bg-gray-700 text-white rounded p-2" readonly></textarea>
  </div>

  <h2 class="text-xl font-semibold mb-4 text-accent">Atendimentos</h2>

  <form id="form-atendimento">
    <div class="mb-3">
      <label class="block text-sm font-medium mb-1">Atendimento Professor (Registro Inicial)</label>
      <textarea id="atendimento_professor" rows="2" class="w-full bg-gray-700 text-white rounded p-2" readonly></textarea>
    </div>
    
    <div class="mb-3">
      <label class="block text-sm font-medium mb-1">Atendimento Tutor</label>
      <textarea id="atendimento_tutor" rows="2" class="w-full bg-dark-primary text-white rounded p-2"></textarea>
    </div>
    
    <div class="mb-3">
      <label class="block text-sm font-medium mb-1">Atendimento Coordenação</label>
      <textarea id="atendimento_coordenacao" rows="2" class="w-full bg-dark-primary text-white rounded p-2"></textarea>
    </div>
    
    <div class="mb-3">
      <label class="block text-sm font-medium mb-1">Atendimento Gestão</label>
      <textarea id="atendimento_gestao" rows="2" class="w-full bg-dark-primary text-white rounded p-2"></textarea>
    </div>
    
    <div class="flex gap-2">
      <button id="btn-salvar" type="submit" class="px-4 py-2 bg-accent rounded text-white hidden font-semibold hover:bg-emerald-600 transition">Salvar Atendimento</button>
    </div>
  </form>
</main>
</div></body></html>
