<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Editar Ocorr√™ncia</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        'dark-primary': '#0F172A',
        'dark-secondary': '#1E293B',
        'accent': '#10B981',
        'danger': '#DC2626',
        'text-light': '#F8FAFC'
      }
    }
  }
};
</script>

<style>
body {
  background-color: #0F172A;
  color: #F8FAFC;
  font-family: sans-serif;
}
.form-textarea {
  width: 100%;
  padding: 0.75rem;
  border-radius: 0.5rem;
  background-color: #374151;
  color: #F8FAFC;
  border: 1px solid #1E293B;
  transition: all 0.2s;
}
.form-textarea:focus {
  outline: none;
  border-color: #10B981;
  box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.5);
}
.input-readonly {
  background-color: #1F2937;
  cursor: not-allowed;
  opacity: 0.7;
}
</style>
</head>

<body class="bg-dark-primary font-sans text-text-light">
<div id="app-container" class="flex flex-col items-center justify-between p-4 md:p-8 min-h-screen">

  <header class="w-full text-center mb-8 mt-4">
    <h1 class="text-xl sm:text-2xl text-text-light mt-2 font-light tracking-wider border-b border-gray-700 pb-2 inline-block">
      SISTEMA DE GEST√ÉO DE CONVIV√äNCIA ESCOLAR
    </h1><br>
    <h2 class="text-base sm:text-lg text-text-light mt-2 font-light tracking-wider border-b border-gray-700 pb-2 inline-block">
      GEST√ÉO DE OCORR√äNCIAS - EDITAR OCORR√äNCIA
    </h2>

    <div id="btn-voltar-container">
      <button onclick="window.location.href='/gestao_ocorrencia'"
              class="mt-4 px-4 py-2 text-sm font-medium rounded-lg text-gray-300 border border-gray-600 hover:bg-gray-700 transition duration-150 flex items-center mx-auto">
        ‚Üê Voltar ao Menu de Ocorr√™ncias
      </button>
    </div>
  </header>

  <main class="w-full max-w-4xl flex-grow flex justify-center">
    <div class="card w-full p-6 md:p-8 bg-dark-secondary rounded-xl shadow-2xl mb-8">
      <div id="mensagem-status" class="hidden p-3 mb-4 text-sm font-medium text-white rounded-lg" role="alert"></div>

      <div class="mb-4 text-gray-300">
        <strong>N√∫mero:</strong> <span id="numero" class="ml-2 text-accent"></span>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
          <label>Aluno</label>
          <div id="aluno" class="p-2 bg-gray-700 rounded-lg text-sm"></div>
        </div>
        <div>
          <label>Sala</label>
          <div id="sala" class="p-2 bg-gray-700 rounded-lg text-sm"></div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
          <label>Professor Respons√°vel</label>
          <div id="professor" class="p-2 bg-gray-700 rounded-lg text-sm"></div>
        </div>
        <div>
          <label>Tutor</label>
          <div id="tutor" class="p-2 bg-gray-700 rounded-lg text-sm"></div>
        </div>
      </div>

      <div class="mb-6">
        <label>Status</label>
        <div id="status" class="p-2 bg-gray-700 rounded-lg text-sm"></div>
      </div>

      <div class="mb-6">
        <label for="descricao">Descri√ß√£o</label>
        <textarea id="descricao" rows="3" class="form-textarea input-readonly" readonly></textarea>
      </div>

      <form id="form-atendimento">
        <div class="mb-4">
          <label>Atendimento Professor</label>
          <textarea id="atendimento_professor" rows="2" class="form-textarea input-readonly" readonly></textarea>
        </div>
        <div class="mb-4">
          <label>Atendimento Tutor</label>
          <textarea id="atendimento_tutor" rows="2" class="form-textarea"></textarea>
        </div>
        <div class="mb-4">
          <label>Atendimento Coordena√ß√£o</label>
          <textarea id="atendimento_coordenacao" rows="2" class="form-textarea"></textarea>
        </div>
        <div class="mb-6">
          <label>Atendimento Gest√£o</label>
          <textarea id="atendimento_gestao" rows="2" class="form-textarea"></textarea>
        </div>

        <button id="btn-salvar" type="submit"
                class="hidden w-full bg-accent hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out shadow-lg shadow-emerald-500/50 flex items-center justify-center space-x-2 transform hover:scale-[1.01]">
          üíæ <span>SALVAR ATENDIMENTO</span>
        </button>
      </form>
    </div>
  </main>

  <footer class="w-full text-center mt-10 p-4 text-gray-400 text-sm border-t border-gray-800">
    <p class="mb-1 text-base font-medium">
      DESENVOLVEDOR: MARCELO ANDR√â NOGUEIRA CARDES
    </p>
    <p class="text-xs font-light tracking-wide">
      LICENCIADO: E.E. PEI PROFESSORA IRENE DIAS RIBEIRO
    </p>
  </footer>
</div>

<script>
let numeroGlobal = null;

function mostrarMensagem(texto, tipo = 'info') {
  const msg = document.getElementById('mensagem-status');
  msg.textContent = texto;
  msg.classList.remove('hidden', 'bg-accent', 'bg-danger', 'bg-dark-secondary');
  if (tipo === 'success') msg.classList.add('bg-accent');
  else if (tipo === 'danger') msg.classList.add('bg-danger');
  else msg.classList.add('bg-dark-secondary');
  setTimeout(() => msg.classList.add('hidden'), 4000);
}

async function carregarDetalhes(numero) {
  try {
    mostrarMensagem('Carregando...', 'info');
    const resp = await fetch(`/api/ocorrencia_detalhes?numero=${numero}`);
    const data = await resp.json();
    if (data.error) throw new Error(data.error);

    document.getElementById('numero').textContent = data.numero;
    document.getElementById('aluno').textContent = data.aluno_nome;
    document.getElementById('sala').textContent = data.sala_nome;
    document.getElementById('professor').textContent = data.professor_nome;
    document.getElementById('tutor').textContent = data.tutor_nome;
    document.getElementById('status').textContent = data.status;
    document.getElementById('descricao').value = data.descricao || '';
    document.getElementById('atendimento_professor').value = data.atendimento_professor || '';
    document.getElementById('atendimento_tutor').value = data.atendimento_tutor || '';
    document.getElementById('atendimento_coordenacao').value = data.atendimento_coordenacao || '';
    document.getElementById('atendimento_gestao').value = data.atendimento_gestao || '';

    if (
      !data.atendimento_tutor ||
      !data.atendimento_coordenacao ||
      !data.atendimento_gestao
    ) {
      document.getElementById('btn-salvar').classList.remove('hidden');
    }

    mostrarMensagem('Detalhes carregados', 'success');
  } catch (e) {
    console.error(e);
    mostrarMensagem('Erro ao carregar: ' + e.message, 'danger');
  }
}

async function salvarAtendimento() {
  try {
    const nivel = ['tutor', 'coordenacao', 'gestao'].find(n =>
      document.getElementById(`atendimento_${n}`).value.trim() &&
      !document.getElementById(`atendimento_${n}`).readOnly
    );
    if (!nivel) return mostrarMensagem('Nenhum campo de atendimento preenchido', 'danger');

    const texto = document.getElementById(`atendimento_${nivel}`).value.trim();

    mostrarMensagem('Salvando atendimento...', 'info');

    const resp = await fetch(`/api/registrar_atendimento/${numeroGlobal}`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ nivel, texto })
    });
    const result = await resp.json();

    if (!resp.ok || result.error) throw new Error(result.error || 'Erro ao salvar');

    mostrarMensagem('Atendimento salvo com sucesso!', 'success');
    setTimeout(() => {
      window.location.href = '/gestao_ocorrencia';
    }, 1000);
  } catch (e) {
    console.error(e);
    mostrarMensagem('Erro ao salvar: ' + e.message, 'danger');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(window.location.search);
  numeroGlobal = params.get('id') || params.get('numero');
  if (!numeroGlobal) return mostrarMensagem('Ocorr√™ncia n√£o especificada', 'danger');
  carregarDetalhes(numeroGlobal);
  document.getElementById('form-atendimento').addEventListener('submit', e => {
    e.preventDefault();
    salvarAtendimento();
  });
});
</script>
</body>
</html>
