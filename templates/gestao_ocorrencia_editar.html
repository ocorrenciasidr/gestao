<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Editar Ocorrência</title>
<script src="https://cdn.tailwindcss.com"></script>

<script>
tailwind.config = {
    theme: {
        extend: {
            colors: {
                'dark-primary': '#0F172A',
                'dark-secondary': '#1E293B',
                'accent': '#10B981',
                'text-light': '#F8FAFC',
            }
        }
    }
};

// ID da ocorrência global
let numeroGlobal = null;

document.addEventListener("DOMContentLoaded", async () => {
    // Obtém ID da ocorrência da URL
    const params = new URLSearchParams(window.location.search);
    numeroGlobal = params.get("id") || params.get("numero");
    if (!numeroGlobal) {
        alert("Número da ocorrência não fornecido.");
        return;
    }

    // Carrega dados da ocorrência
    await carregarDetalhes();

    // Configura campos habilitados pelo tipo do usuário
    const userType = localStorage.getItem("tipo_usuario");
    configurarCamposPorTipo(userType);
});

// Habilita apenas os campos do tipo do usuário
function configurarCamposPorTipo(tipo) {
    const campos = {
        T: ["atendimento_tutor"],
        C: ["atendimento_coordenacao"],
        G: ["atendimento_gestao"]
    };
    const todosOsCampos = ["atendimento_tutor","atendimento_coordenacao","atendimento_gestao"];
    todosOsCampos.forEach(id => document.getElementById(id).disabled = true);
    if (campos[tipo]) campos[tipo].forEach(id => document.getElementById(id).disabled = false);
}

// Carrega detalhes da ocorrência via API e preenche campos
async function carregarDetalhes() {
    try {
        const resp = await fetch(`/api/ocorrencias/${numeroGlobal}`);
        if (!resp.ok) throw new Error("Falha ao carregar dados da ocorrência.");
        const data = await resp.json();

        // Preenche campos da tela
        document.getElementById("descricao").value = data.descricao || "";
        document.getElementById("atendimento_tutor").value = data.atendimento_tutor || "";
        document.getElementById("atendimento_coordenacao").value = data.atendimento_coordenacao || "";
        document.getElementById("atendimento_gestao").value = data.atendimento_gestao || "";

        document.getElementById("numero").textContent = data.numero || "";
        document.getElementById("aluno").textContent = data.aluno_nome || "";
        document.getElementById("sala").textContent = data.sala_nome || "";
        document.getElementById("professor").textContent = data.professor_nome || "";
        document.getElementById("tutor").textContent = data.tutor_nome || "";
        document.getElementById("status").textContent = data.status || "";
    } catch (e) {
        console.error(e);
        mostrarMensagem("Erro ao carregar detalhes da ocorrência.", "error");
    }
}

// Salva o atendimento
async function salvarAtendimento() {
    const userType = localStorage.getItem("tipo_usuario");
    const campos = { T:"atendimento_tutor", C:"atendimento_coordenacao", G:"atendimento_gestao" };
    const campoPermitido = campos[userType];
    if (!campoPermitido) return mostrarMensagem("Você não tem permissão para salvar este campo.", "error");

    const valor = document.getElementById(campoPermitido).value.trim();
    if (!valor) return mostrarMensagem("Preencha o campo de atendimento antes de salvar.", "error");

    try {
        const response = await fetch(`/api/registrar_atendimento/${numeroGlobal}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nivel: userType.toLowerCase(), texto: valor })
        });

        const result = await response.json();
        if (response.ok) {
            mostrarMensagem("Atendimento salvo com sucesso!", "success");
            await carregarDetalhes(); // Atualiza a tela após salvar
        } else {
            console.error(result);
            mostrarMensagem(result.error || "Erro ao salvar atendimento.", "error");
        }
    } catch (e) {
        console.error(e);
        mostrarMensagem("Falha na conexão com o servidor.", "error");
    }
}

function mostrarMensagem(texto, tipo) {
    const msg = document.getElementById("mensagem-status");
    msg.textContent = texto;
    msg.className = `text-center text-white px-4 py-2 rounded-lg my-4 mx-auto max-w-md ${
        tipo === "success" ? "bg-green-600" : "bg-red-600"
    }`;
    msg.classList.remove("hidden");
    setTimeout(() => msg.classList.add("hidden"), 3000);
}
</script>

<style>
.form-textarea {
    width: 100%;
    padding: 0.75rem;
    border-radius: 0.5rem;
    background-color: #374151;
    color: #F8FAFC;
    border: 1px solid #1E293B;
}
.form-textarea:focus { outline: none; border-color: #10B981; box-shadow: 0 0 0 3px rgba(16,185,129,0.5);}
</style>
</head>

<body class="bg-dark-primary text-text-light font-sans p-6">
<header class="text-center mb-8">
    <h1 class="text-2xl font-light border-b border-gray-700 pb-2 inline-block">SISTEMA DE GESTÃO DE CONVIVÊNCIA ESCOLAR</h1><br>
    <h2 class="text-lg font-light border-b border-gray-700 pb-2 inline-block">EDITAR ATENDIMENTO DE OCORRÊNCIA</h2>
</header>

<div id="mensagem-status" class="hidden"></div>

<main class="max-w-4xl mx-auto bg-dark-secondary rounded-xl shadow p-6 space-y-6">
    <div>
        <label for="descricao" class="block text-sm text-gray-400 mb-1">Descrição da Ocorrência</label>
        <textarea id="descricao" rows="3" disabled class="form-textarea"></textarea>
    </div>

    <div>
        <label for="atendimento_tutor" class="block text-sm text-gray-400 mb-1">Atendimento Tutor</label>
        <textarea id="atendimento_tutor" rows="3" class="form-textarea"></textarea>
    </div>

    <div>
        <label for="atendimento_coordenacao" class="block text-sm text-gray-400 mb-1">Atendimento Coordenação</label>
        <textarea id="atendimento_coordenacao" rows="3" class="form-textarea"></textarea>
    </div>

    <div>
        <label for="atendimento_gestao" class="block text-sm text-gray-400 mb-1">Atendimento Gestão</label>
        <textarea id="atendimento_gestao" rows="3" class="form-textarea"></textarea>
    </div>

    <div class="text-center">
        <button onclick="salvarAtendimento()"
                class="bg-accent hover:bg-green-600 text-white font-semibold px-6 py-2 rounded-lg transition">
            Salvar Atendimento
        </button>
    </div>

    <div class="text-center mt-6">
        <button onclick="window.location.href='/gestao_ocorrencia'"
                class="px-4 py-2 text-sm font-medium rounded-lg text-gray-300 border border-gray-600 hover:bg-gray-700 transition duration-150">
            Voltar ao Menu
        </button>
    </div>
</main>

<footer class="w-full text-center mt-10 p-4 text-gray-400 text-sm border-t border-gray-800"> 
    <p class="mb-1 text-base font-medium">DESENVOLVEDOR: MARCELO ANDRÉ NOGUEIRA CARDES</p>
    <p class="text-xs font-light tracking-wide">LICENCIADO: E.E. PEI PROFESSORA IRENE DIAS RIBEIRO</p>
</footer>
</body>
</html>
